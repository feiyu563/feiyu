
<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Python开发【第十五篇】：Web框架之Tornado - 武沛齐 - 博客园</title>
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=m_FXmwz3wxZoecUwNEK23PAzc-j9vbX_C6MblJ5ouMc1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="/skins/SimpleBlue/bundle-SimpleBlue.css?v=jJERBFSojhmgst84aaRDal9S3q1WoO-WcNudmMzGJS81"/>
<link type="text/css" rel="stylesheet" href="/blog/customcss/133379.css?v=YSNZANkz7eBKoXq2iHYfghvodkY%3d"/>
<link id="mobile-style" media="only screen and (max-width: 768px)" type="text/css" rel="stylesheet" href="/skins/SimpleBlue/bundle-SimpleBlue-mobile.css?v=z0BacpCfWeLlXDCM0C158kTP_DMqMbGBapID4f-QztI1"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/wupeiqi/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/wupeiqi/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/wupeiqi/wlwmanifest.xml"/>
<script src="//common.cnblogs.com/script/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'wupeiqi', cb_enable_mathjax=false;var isLogined=false;</script>
<script src="/bundles/blog-common.js?v=CPv0EEqm9L2aCgolHxaZfVYM6J-Sn5az_FJXbjzgr-o1" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/wupeiqi/">Mr.Seven</a></div>
<div class="subtitle"></div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li id="nav_sitehome"><a id="blog_nav_sitehome" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li id="nav_myhome"><a id="blog_nav_myhome" class="menu" href="http://www.cnblogs.com/wupeiqi/">首页</a></li>
<li id="nav_newpost"><a id="blog_nav_newpost" class="menu" rel="nofollow" href="https://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a></li>
<li id="nav_contact"><a id="blog_nav_contact" class="menu" rel="nofollow" href="https://msg.cnblogs.com/send/%E6%AD%A6%E6%B2%9B%E9%BD%90">联系</a></li>
<li id="nav_rss"><a id="blog_nav_rss" class="menu" href="http://www.cnblogs.com/wupeiqi/rss">订阅</a>
<!--<a id="blog_nav_rss_image" class="aHeaderXML" href="http://www.cnblogs.com/wupeiqi/rss"><img src="//www.cnblogs.com/images/xml.gif" alt="订阅" /></a>--></li>
<li id="nav_admin"><a id="blog_nav_admin" class="menu" rel="nofollow" href="https://i.cnblogs.com/">管理</a></li>
</ul>

		<div class="blogStats">
			
			<div id="blog_stats">
<!--done-->
随笔-126&nbsp;
文章-137&nbsp;
评论-259&nbsp;
</div>
			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		
<div id="post_detail">
<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/wupeiqi/articles/5702910.html">Python开发【第十五篇】：Web框架之Tornado</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><h3>概述</h3>
<p>Tornado&nbsp;是&nbsp;FriendFeed&nbsp;使用的可扩展的非阻塞式 web 服务器及其相关工具的开源版本。这个 Web 框架看起来有些像web.py&nbsp;或者&nbsp;Google 的 webapp，不过为了能有效利用非阻塞式服务器环境，这个 Web 框架还包含了一些相关的有用工具 和优化。</p>
<p>Tornado 和现在的主流 Web 服务器框架（包括大多数 Python 的框架）有着明显的区别：它是非阻塞式服务器，而且速度相当快。得利于其 非阻塞的方式和对&nbsp;<a href="http://www.kernel.org/doc/man-pages/online/pages/man4/epoll.4.html">epoll</a>&nbsp;的运用，Tornado 每秒可以处理数以千计的连接，这意味着对于实时 Web 服务来说，Tornado 是一个理想的 Web 框架。我们开发这个 Web 服务器的主要目的就是为了处理 FriendFeed 的实时功能 &mdash;&mdash;在 FriendFeed 的应用里每一个活动用户都会保持着一个服务器连接。（关于如何扩容 服务器，以处理数以千计的客户端的连接的问题，请参阅&nbsp;<a href="http://www.kegel.com/c10k.html">C10K problem</a>。）</p>
<p>下载安装：</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;gutter:true;">pip3 install tornado

源码安装
https://pypi.python.org/packages/source/t/tornado/tornado-4.3.tar.gz
</pre>
</div>
<h3>框架使用</h3>
<p><strong><span style="font-size: 14pt;">一、快速上手</span></strong></p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;collapse:true;;gutter:true;">#!/usr/bin/env python
# -*- coding:utf-8 -*-
  
import tornado.ioloop
import tornado.web
  
  
class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.write("Hello, world")
  
application = tornado.web.Application([
    (r"/index", MainHandler),
])
  
  
if __name__ == "__main__":
    application.listen(8888)
    tornado.ioloop.IOLoop.instance().start()</pre>
</div>
<p>执行过程：</p>
<ul>
<li>第一步：执行脚本，监听 8888 端口</li>
<li>第二步：浏览器客户端访问 /index &nbsp;--&gt; &nbsp;http://127.0.0.1:8888/index</li>
<li>第三步：服务器接受请求，并交由对应的类处理该请求</li>
<li>第四步：类接受到请求之后，根据请求方式（post / get / delete ...）的不同调用并执行相应的方法</li>
<li>第五步：方法返回值的字符串内容发送浏览器</li>
</ul>
<div class="cnblogs_code" onclick="cnblogs_code_show('50bc2742-98be-4464-b93d-6969bce7c980')"><img id="code_img_closed_50bc2742-98be-4464-b93d-6969bce7c980" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_50bc2742-98be-4464-b93d-6969bce7c980" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('50bc2742-98be-4464-b93d-6969bce7c980',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_50bc2742-98be-4464-b93d-6969bce7c980" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span><span style="color: #008000;">
#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
</span><span style="color: #0000ff;">from</span> tornado <span style="color: #0000ff;">import</span><span style="color: #000000;"> httpclient
</span><span style="color: #0000ff;">from</span> tornado.web <span style="color: #0000ff;">import</span><span style="color: #000000;"> asynchronous
</span><span style="color: #0000ff;">from</span> tornado <span style="color: #0000ff;">import</span><span style="color: #000000;"> gen

</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> uimodules as md
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> uimethods as mt

</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
        @asynchronous
        @gen.coroutine
        </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
            </span><span style="color: #0000ff;">print</span> <span style="color: #800000;">'</span><span style="color: #800000;">start get </span><span style="color: #800000;">'</span><span style="color: #000000;">
            http </span>=<span style="color: #000000;"> httpclient.AsyncHTTPClient()
            http.fetch(</span><span style="color: #800000;">"</span><span style="color: #800000;">http://127.0.0.1:8008/post/</span><span style="color: #800000;">"</span><span style="color: #000000;">, self.callback)
            self.write(</span><span style="color: #800000;">'</span><span style="color: #800000;">end</span><span style="color: #800000;">'</span><span style="color: #000000;">)

        </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> callback(self, response):
            </span><span style="color: #0000ff;">print</span><span style="color: #000000;"> response.body

settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">ui_methods</span><span style="color: #800000;">'</span><span style="color: #000000;">: mt,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">ui_modules</span><span style="color: #800000;">'</span><span style="color: #000000;">: md,
}

application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8009<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">异步非阻塞示例</span></div>
<p><strong><span style="font-size: 14pt;">二、路由系统</span></strong></p>
<p>路由系统其实就是 url 和 类 的对应关系，这里不同于其他框架，其他很多框架均是 url 对应 函数，Tornado中每个url对应的是一个类。</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;collapse:true;;gutter:true;">#!/usr/bin/env python
# -*- coding:utf-8 -*-
  
import tornado.ioloop
import tornado.web
  
  
class MainHandler(tornado.web.RequestHandler):
    def get(self):
        self.write("Hello, world")
  
class StoryHandler(tornado.web.RequestHandler):
    def get(self, story_id):
        self.write("You requested the story " + story_id)
  
class BuyHandler(tornado.web.RequestHandler):
    def get(self):
        self.write("buy.wupeiqi.com/index")
  
application = tornado.web.Application([
    (r"/index", MainHandler),
    (r"/story/([0-9]+)", StoryHandler),
])
  
application.add_handlers('buy.wupeiqi.com$', [
    (r'/index',BuyHandler),
])
  
if __name__ == "__main__":
    application.listen(80)
    tornado.ioloop.IOLoop.instance().start()
</pre>
</div>
<p>Tornado中原生支持二级域名的路由，如：</p>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="http://images.cnitblog.com/blog2015/425762/201503/292228582243341.png" alt="" width="324" height="204" /></p>
<p>&nbsp;</p>
<p><strong><span style="font-size: 14pt;">三、模板引擎</span></strong></p>
<p>Tornao中的模板语言和django中类似，模板引擎将模板文件载入内存，然后将数据嵌入其中，最终获取到一个完整的字符串，再将字符串返回给请求者。</p>
<p>Tornado 的模板支持&ldquo;控制语句&rdquo;和&ldquo;表达语句&rdquo;，控制语句是使用&nbsp;<code>{%</code>&nbsp;和&nbsp;<code>%}</code>&nbsp;包起来的 例如&nbsp;<code>{% if len(items) &gt; 2 %}</code>。表达语句是使用&nbsp;<code>{{</code>&nbsp;和&nbsp;<code>}}</code>&nbsp;包起来的，例如&nbsp;<code>{{ items[0] }}</code>。</p>
<p>控制语句和对应的 Python 语句的格式基本完全相同。我们支持&nbsp;<code>if</code>、<code>for</code>、<code>while</code>&nbsp;和&nbsp;<code>try</code>，这些语句逻辑结束的位置需要用&nbsp;<code>{% end %}</code>&nbsp;做标记。还通过&nbsp;<code>extends</code>&nbsp;和&nbsp;<code>block</code>&nbsp;语句实现了模板继承。这些在&nbsp;<a href="http://github.com/facebook/tornado/blob/master/tornado/template.py"><code>template</code>&nbsp;模块</a>&nbsp;的代码文档中有着详细的描述。</p>
<p>注：在使用模板前需要在setting中设置模板路径："template_path" : "tpl"</p>
<p>1、基本使用</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('268070af-e323-4a30-b37c-c95bc899648f')"><img id="code_img_closed_268070af-e323-4a30-b37c-c95bc899648f" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_268070af-e323-4a30-b37c-c95bc899648f" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('268070af-e323-4a30-b37c-c95bc899648f',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_268070af-e323-4a30-b37c-c95bc899648f" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
  
<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
  
  
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.render(</span><span style="color: #800000;">"</span><span style="color: #800000;">index.html</span><span style="color: #800000;">"</span>, list_info = [11,22,33<span style="color: #000000;">])
  
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
])
  
  
</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8888<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">app.py</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('8c680a52-adc0-4bc6-9356-e381468d4608')"><img id="code_img_closed_8c680a52-adc0-4bc6-9356-e381468d4608" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_8c680a52-adc0-4bc6-9356-e381468d4608" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('8c680a52-adc0-4bc6-9356-e381468d4608',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_8c680a52-adc0-4bc6-9356-e381468d4608" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv=<span style="color: #800000;">"</span><span style="color: #800000;">Content-Type</span><span style="color: #800000;">"</span> content=<span style="color: #800000;">"</span><span style="color: #800000;">text/html; charset=UTF-8</span><span style="color: #800000;">"</span>/&gt;
    &lt;title&gt;老男孩&lt;/title&gt;
    &lt;link href=<span style="color: #800000;">"</span><span style="color: #800000;">{{static_url(</span><span style="color: #800000;">"</span>css/common.css<span style="color: #800000;">"</span><span style="color: #800000;">)}}</span><span style="color: #800000;">"</span> rel=<span style="color: #800000;">"</span><span style="color: #800000;">stylesheet</span><span style="color: #800000;">"</span> /&gt;
&lt;/head&gt;
&lt;body&gt;

    &lt;div&gt;
        &lt;ul&gt;<span style="color: #000000;">
            {</span>% <span style="color: #0000ff;">for</span> item <span style="color: #0000ff;">in</span> list_info %<span style="color: #000000;">}
                </span>&lt;li&gt;{{item}}&lt;/li&gt;<span style="color: #000000;">
            {</span>% end %<span style="color: #000000;">}
        </span>&lt;/ul&gt;
    &lt;/div&gt;
    
    &lt;script src=<span style="color: #800000;">"</span><span style="color: #800000;">{{static_url(</span><span style="color: #800000;">"</span>js/jquery-1.8.2.min.js<span style="color: #800000;">"</span><span style="color: #800000;">)}}</span><span style="color: #800000;">"</span>&gt;&lt;/script&gt;
    
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">index.html</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('8c264a19-9058-4b05-a532-854c8bb7469f')"><img id="code_img_closed_8c264a19-9058-4b05-a532-854c8bb7469f" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_8c264a19-9058-4b05-a532-854c8bb7469f" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('8c264a19-9058-4b05-a532-854c8bb7469f',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_8c264a19-9058-4b05-a532-854c8bb7469f" class="cnblogs_code_hide">
<pre><span style="color: #000000;">在模板中默认提供了一些函数、字段、类以供模板使用：

escape: tornado.escape.xhtml_escape 的別名
xhtml_escape: tornado.escape.xhtml_escape 的別名
url_escape: tornado.escape.url_escape 的別名
json_encode: tornado.escape.json_encode 的別名
squeeze: tornado.escape.squeeze 的別名
linkify: tornado.escape.linkify 的別名
datetime: Python 的 datetime 模组
handler: 当前的 RequestHandler 对象
request: handler.request 的別名
current_user: handler.current_user 的別名
locale: handler.locale 的別名
_: handler.locale.translate 的別名
static_url: </span><span style="color: #0000ff;">for</span><span style="color: #000000;"> handler.static_url 的別名
xsrf_form_html: handler.xsrf_form_html 的別名</span></pre>
</div>
<span class="cnblogs_code_collapse">其他方法</span></div>
<p>2、母版</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('6585bdda-3dc4-4917-8997-06d7b1174867')"><img id="code_img_closed_6585bdda-3dc4-4917-8997-06d7b1174867" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_6585bdda-3dc4-4917-8997-06d7b1174867" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('6585bdda-3dc4-4917-8997-06d7b1174867',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_6585bdda-3dc4-4917-8997-06d7b1174867" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">meta </span><span style="color: #ff0000;">http-equiv</span><span style="color: #0000ff;">="Content-Type"</span><span style="color: #ff0000;"> content</span><span style="color: #0000ff;">="text/html; charset=UTF-8"</span><span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>老男孩<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">link </span><span style="color: #ff0000;">href</span><span style="color: #0000ff;">="{{static_url("</span><span style="color: #ff0000;">css/common.css")}}" rel</span><span style="color: #0000ff;">="stylesheet"</span> <span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
    {% block CSS %}{% end %}
</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="pg-header"</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
    
    {% block RenderBody %}{% end %}
   
    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">src</span><span style="color: #0000ff;">="{{static_url("</span><span style="color: #ff0000;">js/jquery-1.8.2.min.js")}}"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
    
    {% block JavaScript %}{% end %}
</span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<span class="cnblogs_code_collapse">layout.html</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('378e18be-faf1-4573-ba06-b302476e441c')"><img id="code_img_closed_378e18be-faf1-4573-ba06-b302476e441c" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_378e18be-faf1-4573-ba06-b302476e441c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('378e18be-faf1-4573-ba06-b302476e441c',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_378e18be-faf1-4573-ba06-b302476e441c" class="cnblogs_code_hide">
<pre><span style="color: #000000;">{% extends 'layout.html'%}
{% block CSS %}
    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">link </span><span style="color: #ff0000;">href</span><span style="color: #0000ff;">="{{static_url("</span><span style="color: #ff0000;">css/index.css")}}" rel</span><span style="color: #0000ff;">="stylesheet"</span> <span style="color: #0000ff;">/&gt;</span><span style="color: #000000;">
{% end %}

{% block RenderBody %}
    </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">h1</span><span style="color: #0000ff;">&gt;</span>Index<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">h1</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ul</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
    {%  for item in li %}
        </span><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">li</span><span style="color: #0000ff;">&gt;</span>{{item}}<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">li</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
    {% end %}
    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ul</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">

{% end %}

{% block JavaScript %}
    
{% end %}</span></pre>
</div>
<span class="cnblogs_code_collapse">index.html</span></div>
<p>3、导入</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('800e96fd-316c-4e8b-97d7-57c0757c5083')"><img id="code_img_closed_800e96fd-316c-4e8b-97d7-57c0757c5083" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_800e96fd-316c-4e8b-97d7-57c0757c5083" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('800e96fd-316c-4e8b-97d7-57c0757c5083',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_800e96fd-316c-4e8b-97d7-57c0757c5083" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">ul</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">li</span><span style="color: #0000ff;">&gt;</span>1024<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">li</span><span style="color: #0000ff;">&gt;</span>
        <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">li</span><span style="color: #0000ff;">&gt;</span>42区<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">li</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">ul</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<span class="cnblogs_code_collapse">header.html</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('bbffb447-71ec-481a-9814-4c2abf31a28e')"><img id="code_img_closed_bbffb447-71ec-481a-9814-4c2abf31a28e" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_bbffb447-71ec-481a-9814-4c2abf31a28e" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('bbffb447-71ec-481a-9814-4c2abf31a28e',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_bbffb447-71ec-481a-9814-4c2abf31a28e" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">&lt;!</span><span style="color: #ff00ff;">DOCTYPE html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">meta </span><span style="color: #ff0000;">http-equiv</span><span style="color: #0000ff;">="Content-Type"</span><span style="color: #ff0000;"> content</span><span style="color: #0000ff;">="text/html; charset=UTF-8"</span><span style="color: #0000ff;">/&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>老男孩<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">title</span><span style="color: #0000ff;">&gt;</span>
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">link </span><span style="color: #ff0000;">href</span><span style="color: #0000ff;">="{{static_url("</span><span style="color: #ff0000;">css/common.css")}}" rel</span><span style="color: #0000ff;">="stylesheet"</span> <span style="color: #0000ff;">/&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">head</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>

    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">div </span><span style="color: #ff0000;">class</span><span style="color: #0000ff;">="pg-header"</span><span style="color: #0000ff;">&gt;</span><span style="color: #000000;">
        {% include 'header.html' %}
    </span><span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">div</span><span style="color: #0000ff;">&gt;</span>
    
    <span style="color: #0000ff;">&lt;</span><span style="color: #800000;">script </span><span style="color: #ff0000;">src</span><span style="color: #0000ff;">="{{static_url("</span><span style="color: #ff0000;">js/jquery-1.8.2.min.js")}}"</span><span style="color: #0000ff;">&gt;&lt;/</span><span style="color: #800000;">script</span><span style="color: #0000ff;">&gt;</span>
    
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">body</span><span style="color: #0000ff;">&gt;</span>
<span style="color: #0000ff;">&lt;/</span><span style="color: #800000;">html</span><span style="color: #0000ff;">&gt;</span></pre>
</div>
<span class="cnblogs_code_collapse">index.html</span></div>
<p>4、自定义UIMethod以UIModule</p>
<p>a. 定义</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('6dab7e07-cbb6-4f6d-94c0-557bb8eea9a3')"><img id="code_img_closed_6dab7e07-cbb6-4f6d-94c0-557bb8eea9a3" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_6dab7e07-cbb6-4f6d-94c0-557bb8eea9a3" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('6dab7e07-cbb6-4f6d-94c0-557bb8eea9a3',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_6dab7e07-cbb6-4f6d-94c0-557bb8eea9a3" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;"> uimethods.py</span>
 
<span style="color: #0000ff;">def</span><span style="color: #000000;"> tab(self):
    </span><span style="color: #0000ff;">return</span> <span style="color: #800000;">'</span><span style="color: #800000;">UIMethod</span><span style="color: #800000;">'</span></pre>
</div>
<span class="cnblogs_code_collapse">uimethods.py</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('bc019da4-f379-4a47-b09d-82c5a87505b0')"><img id="code_img_closed_bc019da4-f379-4a47-b09d-82c5a87505b0" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_bc019da4-f379-4a47-b09d-82c5a87505b0" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('bc019da4-f379-4a47-b09d-82c5a87505b0',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_bc019da4-f379-4a47-b09d-82c5a87505b0" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff;">from</span> tornado.web <span style="color: #0000ff;">import</span><span style="color: #000000;"> UIModule
</span><span style="color: #0000ff;">from</span> tornado <span style="color: #0000ff;">import</span><span style="color: #000000;"> escape

</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> custom(UIModule):

    </span><span style="color: #0000ff;">def</span> render(self, *args, **<span style="color: #000000;">kwargs):
        </span><span style="color: #0000ff;">return</span> escape.xhtml_escape(<span style="color: #800000;">'</span><span style="color: #800000;">&lt;h1&gt;wupeiqi&lt;/h1&gt;</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #008000;">#</span><span style="color: #008000;">return escape.xhtml_escape('&lt;h1&gt;wupeiqi&lt;/h1&gt;')</span></pre>
</div>
<span class="cnblogs_code_collapse">uimodules.py</span></div>
<p>b. 注册</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('1cf2182e-f1e8-4c51-9bc4-a4322b3b74cb')"><img id="code_img_closed_1cf2182e-f1e8-4c51-9bc4-a4322b3b74cb" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_1cf2182e-f1e8-4c51-9bc4-a4322b3b74cb" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('1cf2182e-f1e8-4c51-9bc4-a4322b3b74cb',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_1cf2182e-f1e8-4c51-9bc4-a4322b3b74cb" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span><span style="color: #008000;">
#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
</span><span style="color: #0000ff;">from</span> tornado.escape <span style="color: #0000ff;">import</span><span style="color: #000000;"> linkify
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> uimodules as md
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> uimethods as mt

</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">index.html</span><span style="color: #800000;">'</span><span style="color: #000000;">)

settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">ui_methods</span><span style="color: #800000;">'</span><span style="color: #000000;">: mt,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">ui_modules</span><span style="color: #800000;">'</span><span style="color: #000000;">: md,
}

application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8009<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>c. 使用</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('9b2e244a-a891-4045-919d-4e1f4941619c')"><img id="code_img_closed_9b2e244a-a891-4045-919d-4e1f4941619c" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_9b2e244a-a891-4045-919d-4e1f4941619c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('9b2e244a-a891-4045-919d-4e1f4941619c',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_9b2e244a-a891-4045-919d-4e1f4941619c" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head lang=<span style="color: #800000;">"</span><span style="color: #800000;">en</span><span style="color: #800000;">"</span>&gt;
    &lt;meta charset=<span style="color: #800000;">"</span><span style="color: #800000;">UTF-8</span><span style="color: #800000;">"</span>&gt;
    &lt;title&gt;&lt;/title&gt;
    &lt;link href=<span style="color: #800000;">"</span><span style="color: #800000;">{{static_url(</span><span style="color: #800000;">"</span>commons.css<span style="color: #800000;">"</span><span style="color: #800000;">)}}</span><span style="color: #800000;">"</span> rel=<span style="color: #800000;">"</span><span style="color: #800000;">stylesheet</span><span style="color: #800000;">"</span> /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;hello&lt;/h1&gt;<span style="color: #000000;">
    {</span>% module custom(123) %<span style="color: #000000;">}
    {{ tab() }}
</span>&lt;/body&gt;</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p><strong><span style="font-size: 14pt;">四、静态文件</span></strong></p>
<p>对于静态文件，可以配置静态文件的目录和前段使用时的前缀，并且Tornaodo还支持静态文件缓存。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('4f29814d-84b1-46b7-b93f-859b57870a27')"><img id="code_img_closed_4f29814d-84b1-46b7-b93f-859b57870a27" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_4f29814d-84b1-46b7-b93f-859b57870a27" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('4f29814d-84b1-46b7-b93f-859b57870a27',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_4f29814d-84b1-46b7-b93f-859b57870a27" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
 
<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
 
 
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">home/index.html</span><span style="color: #800000;">'</span><span style="color: #000000;">)
 
settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
}
 
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)
 
 
</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>80<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">app.py</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('627c34cc-0f39-489b-bd8d-0ceababd1c5b')"><img id="code_img_closed_627c34cc-0f39-489b-bd8d-0ceababd1c5b" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_627c34cc-0f39-489b-bd8d-0ceababd1c5b" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('627c34cc-0f39-489b-bd8d-0ceababd1c5b',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_627c34cc-0f39-489b-bd8d-0ceababd1c5b" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head lang=<span style="color: #800000;">"</span><span style="color: #800000;">en</span><span style="color: #800000;">"</span>&gt;
    &lt;meta charset=<span style="color: #800000;">"</span><span style="color: #800000;">UTF-8</span><span style="color: #800000;">"</span>&gt;
    &lt;title&gt;&lt;/title&gt;
    &lt;link href=<span style="color: #800000;">"</span><span style="color: #800000;">{{static_url(</span><span style="color: #800000;">"</span>commons.css<span style="color: #800000;">"</span><span style="color: #800000;">)}}</span><span style="color: #800000;">"</span> rel=<span style="color: #800000;">"</span><span style="color: #800000;">stylesheet</span><span style="color: #800000;">"</span> /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;hello&lt;/h1&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">index.html</span></div>
<p>注：静态文件缓存的实现</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('f8f00892-fcc0-427a-876a-aa4fbbe2f6b7')"><img id="code_img_closed_f8f00892-fcc0-427a-876a-aa4fbbe2f6b7" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_f8f00892-fcc0-427a-876a-aa4fbbe2f6b7" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('f8f00892-fcc0-427a-876a-aa4fbbe2f6b7',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_f8f00892-fcc0-427a-876a-aa4fbbe2f6b7" class="cnblogs_code_hide">
<pre>    <span style="color: #0000ff;">def</span><span style="color: #000000;"> get_content_version(cls, abspath):
        </span><span style="color: #800000;">"""</span><span style="color: #800000;">Returns a version string for the resource at the given path.

        This class method may be overridden by subclasses.  The
        default implementation is a hash of the file's contents.

        .. versionadded:: 3.1
        </span><span style="color: #800000;">"""</span><span style="color: #000000;">
        data </span>=<span style="color: #000000;"> cls.get_content(abspath)
        hasher </span>=<span style="color: #000000;"> hashlib.md5()
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(data, bytes):
            hasher.update(data)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">for</span> chunk <span style="color: #0000ff;">in</span><span style="color: #000000;"> data:
                hasher.update(chunk)
        </span><span style="color: #0000ff;">return</span> hasher.hexdigest()</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p><strong><span style="font-size: 14pt;">五、cookie</span></strong></p>
<p>Tornado中可以对cookie进行操作，并且还可以对cookie进行签名以放置伪造。</p>
<p>1、基本操作</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('76dffd5d-0d1b-4c14-8e7f-10636e612e14')"><img id="code_img_closed_76dffd5d-0d1b-4c14-8e7f-10636e612e14" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_76dffd5d-0d1b-4c14-8e7f-10636e612e14" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('76dffd5d-0d1b-4c14-8e7f-10636e612e14',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_76dffd5d-0d1b-4c14-8e7f-10636e612e14" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> self.get_cookie(<span style="color: #800000;">"</span><span style="color: #800000;">mycookie</span><span style="color: #800000;">"</span><span style="color: #000000;">):
            self.set_cookie(</span><span style="color: #800000;">"</span><span style="color: #800000;">mycookie</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">myvalue</span><span style="color: #800000;">"</span><span style="color: #000000;">)
            self.write(</span><span style="color: #800000;">"</span><span style="color: #800000;">Your cookie was not set yet!</span><span style="color: #800000;">"</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self.write(</span><span style="color: #800000;">"</span><span style="color: #800000;">Your cookie was set!</span><span style="color: #800000;">"</span>)</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>2、加密cookie（签名）</p>
<p>Cookie 很容易被恶意的客户端伪造。加入你想在 cookie 中保存当前登陆用户的 id 之类的信息，你需要对 cookie 作签名以防止伪造。Tornado 通过 set_secure_cookie 和 get_secure_cookie 方法直接支持了这种功能。 要使用这些方法，你需要在创建应用时提供一个密钥，名字为 cookie_secret。 你可以把它作为一个关键词参数传入应用的设置中：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('94902b80-b605-48f2-a249-42ded972630c')"><img id="code_img_closed_94902b80-b605-48f2-a249-42ded972630c" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_94902b80-b605-48f2-a249-42ded972630c" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('94902b80-b605-48f2-a249-42ded972630c',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_94902b80-b605-48f2-a249-42ded972630c" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> self.get_secure_cookie(<span style="color: #800000;">"</span><span style="color: #800000;">mycookie</span><span style="color: #800000;">"</span><span style="color: #000000;">):
            self.set_secure_cookie(</span><span style="color: #800000;">"</span><span style="color: #800000;">mycookie</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">myvalue</span><span style="color: #800000;">"</span><span style="color: #000000;">)
            self.write(</span><span style="color: #800000;">"</span><span style="color: #800000;">Your cookie was not set yet!</span><span style="color: #800000;">"</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self.write(</span><span style="color: #800000;">"</span><span style="color: #800000;">Your cookie was set!</span><span style="color: #800000;">"</span><span style="color: #000000;">)
             
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], cookie_secret</span>=<span style="color: #800000;">"</span><span style="color: #800000;">61oETzKXQAGaYdkL5gEmGeJJFuYh7EQnp2XdTP1o/Vo=</span><span style="color: #800000;">"</span>)</pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('1fcf2ada-34e7-499c-a69a-faa90bcf1000')"><img id="code_img_closed_1fcf2ada-34e7-499c-a69a-faa90bcf1000" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_1fcf2ada-34e7-499c-a69a-faa90bcf1000" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('1fcf2ada-34e7-499c-a69a-faa90bcf1000',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_1fcf2ada-34e7-499c-a69a-faa90bcf1000" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">def</span> _create_signature_v1(secret, *<span style="color: #000000;">parts):
    hash </span>= hmac.new(utf8(secret), digestmod=<span style="color: #000000;">hashlib.sha1)
    </span><span style="color: #0000ff;">for</span> part <span style="color: #0000ff;">in</span><span style="color: #000000;"> parts:
        hash.update(utf8(part))
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> utf8(hash.hexdigest())

</span><span style="color: #008000;">#</span><span style="color: #008000;"> 加密</span>
<span style="color: #0000ff;">def</span><span style="color: #000000;"> _create_signature_v2(secret, s):
    hash </span>= hmac.new(utf8(secret), digestmod=<span style="color: #000000;">hashlib.sha256)
    hash.update(utf8(s))
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> utf8(hash.hexdigest())

</span><span style="color: #0000ff;">def</span> create_signed_value(secret, name, value, version=None, clock=<span style="color: #000000;">None,
                        key_version</span>=<span style="color: #000000;">None):
    </span><span style="color: #0000ff;">if</span> version <span style="color: #0000ff;">is</span><span style="color: #000000;"> None:
        version </span>=<span style="color: #000000;"> DEFAULT_SIGNED_VALUE_VERSION
    </span><span style="color: #0000ff;">if</span> clock <span style="color: #0000ff;">is</span><span style="color: #000000;"> None:
        clock </span>=<span style="color: #000000;"> time.time

    timestamp </span>=<span style="color: #000000;"> utf8(str(int(clock())))
    value </span>=<span style="color: #000000;"> base64.b64encode(utf8(value))
    </span><span style="color: #0000ff;">if</span> version == 1<span style="color: #000000;">:
        signature </span>=<span style="color: #000000;"> _create_signature_v1(secret, name, value, timestamp)
        value </span>= b<span style="color: #800000;">"</span><span style="color: #800000;">|</span><span style="color: #800000;">"</span><span style="color: #000000;">.join([value, timestamp, signature])
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> value
    </span><span style="color: #0000ff;">elif</span> version == 2<span style="color: #000000;">:
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> The v2 format consists of a version number and a series of</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> length-prefixed fields "%d:%s", the last of which is a</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> signature, all separated by pipes.  All numbers are in</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> decimal format with no leading zeros.  The signature is an</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> HMAC-SHA256 of the whole string up to that point, including</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> the final pipe.</span>
        <span style="color: #008000;">#
</span>        <span style="color: #008000;">#</span><span style="color: #008000;"> The fields are:</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> - format version (i.e. 2; no length prefix)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> - key version (integer, default is 0)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> - timestamp (integer seconds since epoch)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> - name (not encoded; assumed to be ~alphanumeric)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> - value (base64-encoded)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> - signature (hex-encoded; no length prefix)</span>
        <span style="color: #0000ff;">def</span><span style="color: #000000;"> format_field(s):
            </span><span style="color: #0000ff;">return</span> utf8(<span style="color: #800000;">"</span><span style="color: #800000;">%d:</span><span style="color: #800000;">"</span> % len(s)) +<span style="color: #000000;"> utf8(s)
        to_sign </span>= b<span style="color: #800000;">"</span><span style="color: #800000;">|</span><span style="color: #800000;">"</span><span style="color: #000000;">.join([
            b</span><span style="color: #800000;">"</span><span style="color: #800000;">2</span><span style="color: #800000;">"</span><span style="color: #000000;">,
            format_field(str(key_version </span><span style="color: #0000ff;">or</span><span style="color: #000000;"> 0)),
            format_field(timestamp),
            format_field(name),
            format_field(value),
            b</span><span style="color: #800000;">''</span><span style="color: #000000;">])

        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(secret, dict):
            </span><span style="color: #0000ff;">assert</span> key_version <span style="color: #0000ff;">is</span> <span style="color: #0000ff;">not</span> None, <span style="color: #800000;">'</span><span style="color: #800000;">Key version must be set when sign key dict is used</span><span style="color: #800000;">'</span>
            <span style="color: #0000ff;">assert</span> version &gt;= 2, <span style="color: #800000;">'</span><span style="color: #800000;">Version must be at least 2 for key version support</span><span style="color: #800000;">'</span><span style="color: #000000;">
            secret </span>=<span style="color: #000000;"> secret[key_version]

        signature </span>=<span style="color: #000000;"> _create_signature_v2(secret, to_sign)
        </span><span style="color: #0000ff;">return</span> to_sign +<span style="color: #000000;"> signature
    </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
        </span><span style="color: #0000ff;">raise</span> ValueError(<span style="color: #800000;">"</span><span style="color: #800000;">Unsupported version %d</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> version)

</span><span style="color: #008000;">#</span><span style="color: #008000;"> 解密</span>
<span style="color: #0000ff;">def</span><span style="color: #000000;"> _decode_signed_value_v1(secret, name, value, max_age_days, clock):
    parts </span>= utf8(value).split(b<span style="color: #800000;">"</span><span style="color: #800000;">|</span><span style="color: #800000;">"</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">if</span> len(parts) != 3<span style="color: #000000;">:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    signature </span>= _create_signature_v1(secret, name, parts[0], parts[1<span style="color: #000000;">])
    </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span> _time_independent_equals(parts[2<span style="color: #000000;">], signature):
        gen_log.warning(</span><span style="color: #800000;">"</span><span style="color: #800000;">Invalid cookie signature %r</span><span style="color: #800000;">"</span><span style="color: #000000;">, value)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    timestamp </span>= int(parts[1<span style="color: #000000;">])
    </span><span style="color: #0000ff;">if</span> timestamp &lt; clock() - max_age_days * 86400<span style="color: #000000;">:
        gen_log.warning(</span><span style="color: #800000;">"</span><span style="color: #800000;">Expired cookie %r</span><span style="color: #800000;">"</span><span style="color: #000000;">, value)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    </span><span style="color: #0000ff;">if</span> timestamp &gt; clock() + 31 * 86400<span style="color: #000000;">:
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> _cookie_signature does not hash a delimiter between the</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> parts of the cookie, so an attacker could transfer trailing</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> digits from the payload to the timestamp without altering the</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> signature.  For backwards compatibility, sanity-check timestamp</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> here instead of modifying _cookie_signature.</span>
        gen_log.warning(<span style="color: #800000;">"</span><span style="color: #800000;">Cookie timestamp in future; possible tampering %r</span><span style="color: #800000;">"</span><span style="color: #000000;">,
                        value)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    </span><span style="color: #0000ff;">if</span> parts[1].startswith(b<span style="color: #800000;">"</span><span style="color: #800000;">0</span><span style="color: #800000;">"</span><span style="color: #000000;">):
        gen_log.warning(</span><span style="color: #800000;">"</span><span style="color: #800000;">Tampered cookie %r</span><span style="color: #800000;">"</span><span style="color: #000000;">, value)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;">:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> base64.b64decode(parts[0])
    </span><span style="color: #0000ff;">except</span><span style="color: #000000;"> Exception:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None


</span><span style="color: #0000ff;">def</span><span style="color: #000000;"> _decode_fields_v2(value):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> _consume_field(s):
        length, _, rest </span>= s.partition(b<span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        n </span>=<span style="color: #000000;"> int(length)
        field_value </span>=<span style="color: #000000;"> rest[:n]
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> In python 3, indexing bytes returns small integers; we must</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> use a slice to get a byte string as in python 2.</span>
        <span style="color: #0000ff;">if</span> rest[n:n + 1] != b<span style="color: #800000;">'</span><span style="color: #800000;">|</span><span style="color: #800000;">'</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">raise</span> ValueError(<span style="color: #800000;">"</span><span style="color: #800000;">malformed v2 signed value field</span><span style="color: #800000;">"</span><span style="color: #000000;">)
        rest </span>= rest[n + 1<span style="color: #000000;">:]
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> field_value, rest

    rest </span>= value[2:]  <span style="color: #008000;">#</span><span style="color: #008000;"> remove version number</span>
    key_version, rest =<span style="color: #000000;"> _consume_field(rest)
    timestamp, rest </span>=<span style="color: #000000;"> _consume_field(rest)
    name_field, rest </span>=<span style="color: #000000;"> _consume_field(rest)
    value_field, passed_sig </span>=<span style="color: #000000;"> _consume_field(rest)
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> int(key_version), timestamp, name_field, value_field, passed_sig


</span><span style="color: #0000ff;">def</span><span style="color: #000000;"> _decode_signed_value_v2(secret, name, value, max_age_days, clock):
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;">:
        key_version, timestamp, name_field, value_field, passed_sig </span>=<span style="color: #000000;"> _decode_fields_v2(value)
    </span><span style="color: #0000ff;">except</span><span style="color: #000000;"> ValueError:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    signed_string </span>= value[:-<span style="color: #000000;">len(passed_sig)]

    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(secret, dict):
        </span><span style="color: #0000ff;">try</span><span style="color: #000000;">:
            secret </span>=<span style="color: #000000;"> secret[key_version]
        </span><span style="color: #0000ff;">except</span><span style="color: #000000;"> KeyError:
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None

    expected_sig </span>=<span style="color: #000000;"> _create_signature_v2(secret, signed_string)
    </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> _time_independent_equals(passed_sig, expected_sig):
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    </span><span style="color: #0000ff;">if</span> name_field !=<span style="color: #000000;"> utf8(name):
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    timestamp </span>=<span style="color: #000000;"> int(timestamp)
    </span><span style="color: #0000ff;">if</span> timestamp &lt; clock() - max_age_days * 86400<span style="color: #000000;">:
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> The signature has expired.</span>
        <span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;">:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> base64.b64decode(value_field)
    </span><span style="color: #0000ff;">except</span><span style="color: #000000;"> Exception:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None


</span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get_signature_key_version(value):
    value </span>=<span style="color: #000000;"> utf8(value)
    version </span>=<span style="color: #000000;"> _get_version(value)
    </span><span style="color: #0000ff;">if</span> version &lt; 2<span style="color: #000000;">:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
    </span><span style="color: #0000ff;">try</span><span style="color: #000000;">:
        key_version, _, _, _, _ </span>=<span style="color: #000000;"> _decode_fields_v2(value)
    </span><span style="color: #0000ff;">except</span><span style="color: #000000;"> ValueError:
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None

    </span><span style="color: #0000ff;">return</span> key_version</pre>
</div>
<span class="cnblogs_code_collapse">内部算法</span></div>
<p>签名Cookie的本质是：</p>
<blockquote>
<p>写cookie过程：</p>
<ul>
<li>将值进行base64加密</li>
<li>对除值以外的内容进行签名，哈希算法（无法逆向解析）</li>
<li>拼接 签名 + 加密值</li>
</ul>
<p>读cookie过程：</p>
<ul>
<li>读取 签名 + 加密值</li>
<li>对签名进行验证</li>
<li>base64解密，获取值内容</li>
</ul>
</blockquote>
<p>注：许多API验证机制和安全cookie的实现机制相同。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('b9050e7f-96b2-4398-87ab-31b48756f3e9')"><img id="code_img_closed_b9050e7f-96b2-4398-87ab-31b48756f3e9" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_b9050e7f-96b2-4398-87ab-31b48756f3e9" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b9050e7f-96b2-4398-87ab-31b48756f3e9',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_b9050e7f-96b2-4398-87ab-31b48756f3e9" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
 
<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
 
 
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
 
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        login_user </span>= self.get_secure_cookie(<span style="color: #800000;">"</span><span style="color: #800000;">login_user</span><span style="color: #800000;">"</span><span style="color: #000000;">, None)
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> login_user:
            self.write(login_user)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self.redirect(</span><span style="color: #800000;">'</span><span style="color: #800000;">/login</span><span style="color: #800000;">'</span><span style="color: #000000;">)
 
 
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> LoginHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.current_user()
 
        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">login.html</span><span style="color: #800000;">'</span>, **{<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>: <span style="color: #800000;">''</span><span style="color: #000000;">})
 
    </span><span style="color: #0000ff;">def</span> post(self, *args, **<span style="color: #000000;">kwargs):
 
        username </span>= self.get_argument(<span style="color: #800000;">'</span><span style="color: #800000;">name</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        password </span>= self.get_argument(<span style="color: #800000;">'</span><span style="color: #800000;">pwd</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">if</span> username == <span style="color: #800000;">'</span><span style="color: #800000;">wupeiqi</span><span style="color: #800000;">'</span> <span style="color: #0000ff;">and</span> password == <span style="color: #800000;">'</span><span style="color: #800000;">123</span><span style="color: #800000;">'</span><span style="color: #000000;">:
            self.set_secure_cookie(</span><span style="color: #800000;">'</span><span style="color: #800000;">login_user</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">武沛齐</span><span style="color: #800000;">'</span><span style="color: #000000;">)
            self.redirect(</span><span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">login.html</span><span style="color: #800000;">'</span>, **{<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">用户名或密码错误</span><span style="color: #800000;">'</span><span style="color: #000000;">})
 
settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">cookie_secret</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">aiuasdhflashjdfoiuashdfiuh</span><span style="color: #800000;">'</span><span style="color: #000000;">
}
 
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/login</span><span style="color: #800000;">"</span><span style="color: #000000;">, LoginHandler),
], </span>**<span style="color: #000000;">settings)
 
 
</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8888<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">基于Cookie实现用户验证-Demo</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('ea39dacb-04d8-4192-8497-23f01aec5de4')"><img id="code_img_closed_ea39dacb-04d8-4192-8497-23f01aec5de4" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_ea39dacb-04d8-4192-8497-23f01aec5de4" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('ea39dacb-04d8-4192-8497-23f01aec5de4',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_ea39dacb-04d8-4192-8497-23f01aec5de4" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
 
<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
 
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> BaseHandler(tornado.web.RequestHandler):
 
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get_current_user(self):
        </span><span style="color: #0000ff;">return</span> self.get_secure_cookie(<span style="color: #800000;">"</span><span style="color: #800000;">login_user</span><span style="color: #800000;">"</span><span style="color: #000000;">)
 
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(BaseHandler):
 
    @tornado.web.authenticated
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        login_user </span>=<span style="color: #000000;"> self.current_user
        self.write(login_user)
 
 
 
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> LoginHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.current_user()
 
        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">login.html</span><span style="color: #800000;">'</span>, **{<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>: <span style="color: #800000;">''</span><span style="color: #000000;">})
 
    </span><span style="color: #0000ff;">def</span> post(self, *args, **<span style="color: #000000;">kwargs):
 
        username </span>= self.get_argument(<span style="color: #800000;">'</span><span style="color: #800000;">name</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        password </span>= self.get_argument(<span style="color: #800000;">'</span><span style="color: #800000;">pwd</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">if</span> username == <span style="color: #800000;">'</span><span style="color: #800000;">wupeiqi</span><span style="color: #800000;">'</span> <span style="color: #0000ff;">and</span> password == <span style="color: #800000;">'</span><span style="color: #800000;">123</span><span style="color: #800000;">'</span><span style="color: #000000;">:
            self.set_secure_cookie(</span><span style="color: #800000;">'</span><span style="color: #800000;">login_user</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">武沛齐</span><span style="color: #800000;">'</span><span style="color: #000000;">)
            self.redirect(</span><span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">login.html</span><span style="color: #800000;">'</span>, **{<span style="color: #800000;">'</span><span style="color: #800000;">status</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">用户名或密码错误</span><span style="color: #800000;">'</span><span style="color: #000000;">})
 
settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">cookie_secret</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">aiuasdhflashjdfoiuashdfiuh</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">login_url</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/login</span><span style="color: #800000;">'</span><span style="color: #000000;">
}
 
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/login</span><span style="color: #800000;">"</span><span style="color: #000000;">, LoginHandler),
], </span>**<span style="color: #000000;">settings)
 
 
</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8888<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">基于签名Cookie实现用户验证-Demo</span></div>
<p>3、JavaScript操作Cookie</p>
<p>由于Cookie保存在浏览器端，所以在浏览器端也可以使用JavaScript来操作Cookie。</p>
<div class="cnblogs_Highlighter">
<pre class="brush:javascript;gutter:true;">        /*
        设置cookie，指定秒数过期
         */
        function setCookie(name,value,expires){
            var temp = [];
            var current_date = new Date();
            current_date.setSeconds(current_date.getSeconds() + 5);
            document.cookie = name + "= "+ value +";expires=" + current_date.toUTCString();
        }
</pre>
</div>
<p>对于参数：</p>
<ul>
<li>domain &nbsp; 指定域名下的cookie</li>
<li>path &nbsp; &nbsp; &nbsp; 域名下指定url中的cookie</li>
<li>secure &nbsp; &nbsp;https使用</li>
</ul>
<p>注：jQuery中也有指定的插件 jQuery Cookie 专门用于操作cookie，<a href="http://plugins.jquery.com/cookie/" target="_blank">猛击这里</a></p>
<p><strong><span style="font-size: 14pt;">六、CSRF</span></strong></p>
<p>Tornado中的夸张请求伪造和Django中的相似，<a href="http://en.wikipedia.org/wiki/Cross-site_request_forgery">跨站伪造请求(Cross-site request forgery)</a></p>
<div class="cnblogs_code" onclick="cnblogs_code_show('de4308d1-0a40-435b-aaee-0bfed4da1700')"><img id="code_img_closed_de4308d1-0a40-435b-aaee-0bfed4da1700" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_de4308d1-0a40-435b-aaee-0bfed4da1700" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('de4308d1-0a40-435b-aaee-0bfed4da1700',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_de4308d1-0a40-435b-aaee-0bfed4da1700" class="cnblogs_code_hide">
<pre>settings =<span style="color: #000000;"> {
    </span><span style="color: #800000;">"</span><span style="color: #800000;">xsrf_cookies</span><span style="color: #800000;">"</span><span style="color: #000000;">: True,
}
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/login</span><span style="color: #800000;">"</span><span style="color: #000000;">, LoginHandler),
], </span>**settings)</pre>
</div>
<span class="cnblogs_code_collapse">配置</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('d3093ac1-5f0b-4904-9281-1ba4f9fbd3ba')"><img id="code_img_closed_d3093ac1-5f0b-4904-9281-1ba4f9fbd3ba" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_d3093ac1-5f0b-4904-9281-1ba4f9fbd3ba" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('d3093ac1-5f0b-4904-9281-1ba4f9fbd3ba',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_d3093ac1-5f0b-4904-9281-1ba4f9fbd3ba" class="cnblogs_code_hide">
<pre>&lt;form action=<span style="color: #800000;">"</span><span style="color: #800000;">/new_message</span><span style="color: #800000;">"</span> method=<span style="color: #800000;">"</span><span style="color: #800000;">post</span><span style="color: #800000;">"</span>&gt;<span style="color: #000000;">
  {{ xsrf_form_html() }}
  </span>&lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">text</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">message</span><span style="color: #800000;">"</span>/&gt;
  &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">submit</span><span style="color: #800000;">"</span> value=<span style="color: #800000;">"</span><span style="color: #800000;">Post</span><span style="color: #800000;">"</span>/&gt;
&lt;/form&gt;</pre>
</div>
<span class="cnblogs_code_collapse">使用 - 普通表单</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('ff084440-f5fb-450f-84d7-26089de955f8')"><img id="code_img_closed_ff084440-f5fb-450f-84d7-26089de955f8" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_ff084440-f5fb-450f-84d7-26089de955f8" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('ff084440-f5fb-450f-84d7-26089de955f8',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_ff084440-f5fb-450f-84d7-26089de955f8" class="cnblogs_code_hide">
<pre><span style="color: #000000;">function getCookie(name) {
    var r </span>= document.cookie.match(<span style="color: #800000;">"</span><span style="color: #800000;">\\b</span><span style="color: #800000;">"</span> + name + <span style="color: #800000;">"</span><span style="color: #800000;">=([^;]*)\\b</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    </span><span style="color: #0000ff;">return</span> r ? r[1<span style="color: #000000;">] : undefined;
}

jQuery.postJSON </span>=<span style="color: #000000;"> function(url, args, callback) {
    args._xsrf </span>= getCookie(<span style="color: #800000;">"</span><span style="color: #800000;">_xsrf</span><span style="color: #800000;">"</span><span style="color: #000000;">);
    $.ajax({url: url, data: $.param(args), dataType: </span><span style="color: #800000;">"</span><span style="color: #800000;">text</span><span style="color: #800000;">"</span>, type: <span style="color: #800000;">"</span><span style="color: #800000;">POST</span><span style="color: #800000;">"</span><span style="color: #000000;">,
        success: function(response) {
        callback(eval(</span><span style="color: #800000;">"</span><span style="color: #800000;">(</span><span style="color: #800000;">"</span> + response + <span style="color: #800000;">"</span><span style="color: #800000;">)</span><span style="color: #800000;">"</span><span style="color: #000000;">));
    }});
};</span></pre>
</div>
<span class="cnblogs_code_collapse">使用 - AJAX</span></div>
<p>注：Ajax使用时，本质上就是去获取本地的cookie，携带cookie再来发送请求</p>
<p><strong><span style="font-size: 14pt;">七、上传文件</span></strong></p>
<p>1、Form表单上传</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('b6b72bb0-2550-47c8-b14f-1f382ca4d4d3')"><img id="code_img_closed_b6b72bb0-2550-47c8-b14f-1f382ca4d4d3" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_b6b72bb0-2550-47c8-b14f-1f382ca4d4d3" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b6b72bb0-2550-47c8-b14f-1f382ca4d4d3',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_b6b72bb0-2550-47c8-b14f-1f382ca4d4d3" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
    &lt;meta http-equiv=<span style="color: #800000;">"</span><span style="color: #800000;">Content-Type</span><span style="color: #800000;">"</span> content=<span style="color: #800000;">"</span><span style="color: #800000;">text/html; charset=UTF-8</span><span style="color: #800000;">"</span>/&gt;
    &lt;title&gt;上传文件&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id=<span style="color: #800000;">"</span><span style="color: #800000;">my_form</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">form</span><span style="color: #800000;">"</span> action=<span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span> method=<span style="color: #800000;">"</span><span style="color: #800000;">POST</span><span style="color: #800000;">"</span>  enctype=<span style="color: #800000;">"</span><span style="color: #800000;">multipart/form-data</span><span style="color: #800000;">"</span> &gt;
        &lt;input name=<span style="color: #800000;">"</span><span style="color: #800000;">fff</span><span style="color: #800000;">"</span> id=<span style="color: #800000;">"</span><span style="color: #800000;">my_file</span><span style="color: #800000;">"</span>  type=<span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span> /&gt;
        &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">submit</span><span style="color: #800000;">"</span> value=<span style="color: #800000;">"</span><span style="color: #800000;">提交</span><span style="color: #800000;">"</span>  /&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">HTML</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('748e0668-7e1b-43c0-a517-ba1034f7f2dc')"><img id="code_img_closed_748e0668-7e1b-43c0-a517-ba1034f7f2dc" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_748e0668-7e1b-43c0-a517-ba1034f7f2dc" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('748e0668-7e1b-43c0-a517-ba1034f7f2dc',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_748e0668-7e1b-43c0-a517-ba1034f7f2dc" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):

        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">index.html</span><span style="color: #800000;">'</span><span style="color: #000000;">)

    </span><span style="color: #0000ff;">def</span> post(self, *args, **<span style="color: #000000;">kwargs):
        file_metas </span>= self.request.files[<span style="color: #800000;">"</span><span style="color: #800000;">fff</span><span style="color: #800000;">"</span><span style="color: #000000;">]
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> print(file_metas)</span>
        <span style="color: #0000ff;">for</span> meta <span style="color: #0000ff;">in</span><span style="color: #000000;"> file_metas:
            file_name </span>= meta[<span style="color: #800000;">'</span><span style="color: #800000;">filename</span><span style="color: #800000;">'</span><span style="color: #000000;">]
            with open(file_name,</span><span style="color: #800000;">'</span><span style="color: #800000;">wb</span><span style="color: #800000;">'</span><span style="color: #000000;">) as up:
                up.write(meta[</span><span style="color: #800000;">'</span><span style="color: #800000;">body</span><span style="color: #800000;">'</span><span style="color: #000000;">])

settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
}

application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8000<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">Python</span></div>
<p>2、AJAX上传</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('600428dc-83e2-4c26-9a22-840220e404f8')"><img id="code_img_closed_600428dc-83e2-4c26-9a22-840220e404f8" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_600428dc-83e2-4c26-9a22-840220e404f8" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('600428dc-83e2-4c26-9a22-840220e404f8',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_600428dc-83e2-4c26-9a22-840220e404f8" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head lang=<span style="color: #800000;">"</span><span style="color: #800000;">en</span><span style="color: #800000;">"</span>&gt;
    &lt;meta charset=<span style="color: #800000;">"</span><span style="color: #800000;">UTF-8</span><span style="color: #800000;">"</span>&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span> id=<span style="color: #800000;">"</span><span style="color: #800000;">img</span><span style="color: #800000;">"</span> /&gt;
    &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">button</span><span style="color: #800000;">"</span> onclick=<span style="color: #800000;">"</span><span style="color: #800000;">UploadFile();</span><span style="color: #800000;">"</span> /&gt;
    &lt;script&gt;<span style="color: #000000;">
        function UploadFile(){
            var fileObj </span>= document.getElementById(<span style="color: #800000;">"</span><span style="color: #800000;">img</span><span style="color: #800000;">"</span><span style="color: #000000;">).files[0];

            var form </span>=<span style="color: #000000;"> new FormData();
            form.append(</span><span style="color: #800000;">"</span><span style="color: #800000;">k1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">v1</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            form.append(</span><span style="color: #800000;">"</span><span style="color: #800000;">fff</span><span style="color: #800000;">"</span><span style="color: #000000;">, fileObj);

            var xhr </span>=<span style="color: #000000;"> new XMLHttpRequest();
            xhr.open(</span><span style="color: #800000;">"</span><span style="color: #800000;">post</span><span style="color: #800000;">"</span>, <span style="color: #800000;">'</span><span style="color: #800000;">/index</span><span style="color: #800000;">'</span><span style="color: #000000;">, true);
            xhr.send(form);
        }
    </span>&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">HTML - XMLHttpRequest</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('815aa9b6-8b62-463d-9ccf-d8e7886987ca')"><img id="code_img_closed_815aa9b6-8b62-463d-9ccf-d8e7886987ca" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_815aa9b6-8b62-463d-9ccf-d8e7886987ca" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('815aa9b6-8b62-463d-9ccf-d8e7886987ca',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_815aa9b6-8b62-463d-9ccf-d8e7886987ca" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head lang=<span style="color: #800000;">"</span><span style="color: #800000;">en</span><span style="color: #800000;">"</span>&gt;
    &lt;meta charset=<span style="color: #800000;">"</span><span style="color: #800000;">UTF-8</span><span style="color: #800000;">"</span>&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span> id=<span style="color: #800000;">"</span><span style="color: #800000;">img</span><span style="color: #800000;">"</span> /&gt;
    &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">button</span><span style="color: #800000;">"</span> onclick=<span style="color: #800000;">"</span><span style="color: #800000;">UploadFile();</span><span style="color: #800000;">"</span> /&gt;
    &lt;script&gt;<span style="color: #000000;">
        function UploadFile(){
            var fileObj </span>= $(<span style="color: #800000;">"</span><span style="color: #800000;">#img</span><span style="color: #800000;">"</span><span style="color: #000000;">)[0].files[0];
            var form </span>=<span style="color: #000000;"> new FormData();
            form.append(</span><span style="color: #800000;">"</span><span style="color: #800000;">k1</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">v1</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            form.append(</span><span style="color: #800000;">"</span><span style="color: #800000;">fff</span><span style="color: #800000;">"</span><span style="color: #000000;">, fileObj);

            $.ajax({
                type:</span><span style="color: #800000;">'</span><span style="color: #800000;">POST</span><span style="color: #800000;">'</span><span style="color: #000000;">,
                url: </span><span style="color: #800000;">'</span><span style="color: #800000;">/index</span><span style="color: #800000;">'</span><span style="color: #000000;">,
                data: form,
                processData: false,  </span>// tell jQuery <span style="color: #0000ff;">not</span><span style="color: #000000;"> to process the data
                contentType: false,  </span>// tell jQuery <span style="color: #0000ff;">not</span><span style="color: #000000;"> to set contentType
                success: function(arg){
                    console.log(arg);
                }
            })
        }
    </span>&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">HTML - jQuery</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('01a26509-a14c-401b-8db0-82dc17ce66eb')"><img id="code_img_closed_01a26509-a14c-401b-8db0-82dc17ce66eb" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_01a26509-a14c-401b-8db0-82dc17ce66eb" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('01a26509-a14c-401b-8db0-82dc17ce66eb',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_01a26509-a14c-401b-8db0-82dc17ce66eb" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head lang=<span style="color: #800000;">"</span><span style="color: #800000;">en</span><span style="color: #800000;">"</span>&gt;
    &lt;meta charset=<span style="color: #800000;">"</span><span style="color: #800000;">UTF-8</span><span style="color: #800000;">"</span>&gt;
    &lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;form id=<span style="color: #800000;">"</span><span style="color: #800000;">my_form</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">form</span><span style="color: #800000;">"</span> action=<span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span> method=<span style="color: #800000;">"</span><span style="color: #800000;">POST</span><span style="color: #800000;">"</span>  enctype=<span style="color: #800000;">"</span><span style="color: #800000;">multipart/form-data</span><span style="color: #800000;">"</span> &gt;
        &lt;div id=<span style="color: #800000;">"</span><span style="color: #800000;">main</span><span style="color: #800000;">"</span>&gt;
            &lt;input name=<span style="color: #800000;">"</span><span style="color: #800000;">fff</span><span style="color: #800000;">"</span> id=<span style="color: #800000;">"</span><span style="color: #800000;">my_file</span><span style="color: #800000;">"</span>  type=<span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span> /&gt;
            &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">button</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">action</span><span style="color: #800000;">"</span> value=<span style="color: #800000;">"</span><span style="color: #800000;">Upload</span><span style="color: #800000;">"</span> onclick=<span style="color: #800000;">"</span><span style="color: #800000;">redirect()</span><span style="color: #800000;">"</span>/&gt;
            &lt;iframe id=<span style="color: #800000;">'</span><span style="color: #800000;">my_iframe</span><span style="color: #800000;">'</span> name=<span style="color: #800000;">'</span><span style="color: #800000;">my_iframe</span><span style="color: #800000;">'</span> src=<span style="color: #800000;">""</span>  <span style="color: #0000ff;">class</span>=<span style="color: #800000;">"</span><span style="color: #800000;">hide</span><span style="color: #800000;">"</span>&gt;&lt;/iframe&gt;
        &lt;/div&gt;
    &lt;/form&gt;

    &lt;script&gt;<span style="color: #000000;">
        function redirect(){
            document.getElementById(</span><span style="color: #800000;">'</span><span style="color: #800000;">my_iframe</span><span style="color: #800000;">'</span>).onload =<span style="color: #000000;"> Testt;
            document.getElementById(</span><span style="color: #800000;">'</span><span style="color: #800000;">my_form</span><span style="color: #800000;">'</span>).target = <span style="color: #800000;">'</span><span style="color: #800000;">my_iframe</span><span style="color: #800000;">'</span><span style="color: #000000;">;
            document.getElementById(</span><span style="color: #800000;">'</span><span style="color: #800000;">my_form</span><span style="color: #800000;">'</span><span style="color: #000000;">).submit();

        }
        
        function Testt(ths){
            var t </span>= $(<span style="color: #800000;">"</span><span style="color: #800000;">#my_iframe</span><span style="color: #800000;">"</span>).contents().find(<span style="color: #800000;">"</span><span style="color: #800000;">body</span><span style="color: #800000;">"</span><span style="color: #000000;">).text();
            console.log(t);
        }
    </span>&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">HTML - iframe</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('1c4e7bdc-6e8e-4939-b06e-28991a7faac4')"><img id="code_img_closed_1c4e7bdc-6e8e-4939-b06e-28991a7faac4" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_1c4e7bdc-6e8e-4939-b06e-28991a7faac4" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('1c4e7bdc-6e8e-4939-b06e-28991a7faac4',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_1c4e7bdc-6e8e-4939-b06e-28991a7faac4" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):

        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">index.html</span><span style="color: #800000;">'</span><span style="color: #000000;">)

    </span><span style="color: #0000ff;">def</span> post(self, *args, **<span style="color: #000000;">kwargs):
        file_metas </span>= self.request.files[<span style="color: #800000;">"</span><span style="color: #800000;">fff</span><span style="color: #800000;">"</span><span style="color: #000000;">]
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> print(file_metas)</span>
        <span style="color: #0000ff;">for</span> meta <span style="color: #0000ff;">in</span><span style="color: #000000;"> file_metas:
            file_name </span>= meta[<span style="color: #800000;">'</span><span style="color: #800000;">filename</span><span style="color: #800000;">'</span><span style="color: #000000;">]
            with open(file_name,</span><span style="color: #800000;">'</span><span style="color: #800000;">wb</span><span style="color: #800000;">'</span><span style="color: #000000;">) as up:
                up.write(meta[</span><span style="color: #800000;">'</span><span style="color: #800000;">body</span><span style="color: #800000;">'</span><span style="color: #000000;">])

settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
}

application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8000<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">Python</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('12cbd240-9449-42b2-972e-0803f6e6d6ea')"><img id="code_img_closed_12cbd240-9449-42b2-972e-0803f6e6d6ea" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_12cbd240-9449-42b2-972e-0803f6e6d6ea" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('12cbd240-9449-42b2-972e-0803f6e6d6ea',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_12cbd240-9449-42b2-972e-0803f6e6d6ea" class="cnblogs_code_hide">
<pre>&lt;script type=<span style="color: #800000;">"</span><span style="color: #800000;">text/javascript</span><span style="color: #800000;">"</span>&gt;<span style="color: #000000;">
 
    $(document).ready(function () {
 
        $(</span><span style="color: #800000;">"</span><span style="color: #800000;">#formsubmit</span><span style="color: #800000;">"</span><span style="color: #000000;">).click(function () {
 
            var iframe </span>= $(<span style="color: #800000;">'</span><span style="color: #800000;">&lt;iframe name="postiframe" id="postiframe" style="display: none"&gt;&lt;/iframe&gt;</span><span style="color: #800000;">'</span><span style="color: #000000;">);
 
            $(</span><span style="color: #800000;">"</span><span style="color: #800000;">body</span><span style="color: #800000;">"</span><span style="color: #000000;">).append(iframe);
 
            var form </span>= $(<span style="color: #800000;">'</span><span style="color: #800000;">#theuploadform</span><span style="color: #800000;">'</span><span style="color: #000000;">);
            form.attr(</span><span style="color: #800000;">"</span><span style="color: #800000;">action</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">/upload.aspx</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            form.attr(</span><span style="color: #800000;">"</span><span style="color: #800000;">method</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">post</span><span style="color: #800000;">"</span><span style="color: #000000;">);
 
            form.attr(</span><span style="color: #800000;">"</span><span style="color: #800000;">encoding</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">multipart/form-data</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            form.attr(</span><span style="color: #800000;">"</span><span style="color: #800000;">enctype</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">multipart/form-data</span><span style="color: #800000;">"</span><span style="color: #000000;">);
 
            form.attr(</span><span style="color: #800000;">"</span><span style="color: #800000;">target</span><span style="color: #800000;">"</span>, <span style="color: #800000;">"</span><span style="color: #800000;">postiframe</span><span style="color: #800000;">"</span><span style="color: #000000;">);
            form.attr(</span><span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span>, $(<span style="color: #800000;">'</span><span style="color: #800000;">#userfile</span><span style="color: #800000;">'</span><span style="color: #000000;">).val());
            form.submit();
 
            $(</span><span style="color: #800000;">"</span><span style="color: #800000;">#postiframe</span><span style="color: #800000;">"</span><span style="color: #000000;">).load(function () {
                iframeContents </span>=<span style="color: #000000;"> this.contentWindow.document.body.innerHTML;
                $(</span><span style="color: #800000;">"</span><span style="color: #800000;">#textarea</span><span style="color: #800000;">"</span><span style="color: #000000;">).html(iframeContents);
            });
 
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> false;
 
        });
 
    });
 
</span>&lt;/script&gt;
 
 
&lt;form id=<span style="color: #800000;">"</span><span style="color: #800000;">theuploadform</span><span style="color: #800000;">"</span>&gt;
    &lt;input id=<span style="color: #800000;">"</span><span style="color: #800000;">userfile</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">userfile</span><span style="color: #800000;">"</span> size=<span style="color: #800000;">"</span><span style="color: #800000;">50</span><span style="color: #800000;">"</span> type=<span style="color: #800000;">"</span><span style="color: #800000;">file</span><span style="color: #800000;">"</span> /&gt;
    &lt;input id=<span style="color: #800000;">"</span><span style="color: #800000;">formsubmit</span><span style="color: #800000;">"</span> type=<span style="color: #800000;">"</span><span style="color: #800000;">submit</span><span style="color: #800000;">"</span> value=<span style="color: #800000;">"</span><span style="color: #800000;">Send File</span><span style="color: #800000;">"</span> /&gt;
&lt;/form&gt;
 
&lt;div id=<span style="color: #800000;">"</span><span style="color: #800000;">textarea</span><span style="color: #800000;">"</span>&gt;
&lt;/div&gt;</pre>
</div>
<span class="cnblogs_code_collapse">扩展：基于iframe实现Ajax上传示例</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('652d65a9-2702-46e2-a84c-66a65f447894')"><img id="code_img_closed_652d65a9-2702-46e2-a84c-66a65f447894" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_652d65a9-2702-46e2-a84c-66a65f447894" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('652d65a9-2702-46e2-a84c-66a65f447894',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_652d65a9-2702-46e2-a84c-66a65f447894" class="cnblogs_code_hide">
<pre> $(<span style="color: #800000;">'</span><span style="color: #800000;">#upload_iframe</span><span style="color: #800000;">'</span><span style="color: #000000;">).load(function(){
                    var iframeContents </span>=<span style="color: #000000;"> this.contentWindow.document.body.innerText;
                    iframeContents </span>=<span style="color: #000000;"> JSON.parse(iframeContents);
                   
                })</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('16526255-2982-4d52-b41c-6401397e7d1b')"><img id="code_img_closed_16526255-2982-4d52-b41c-6401397e7d1b" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_16526255-2982-4d52-b41c-6401397e7d1b" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('16526255-2982-4d52-b41c-6401397e7d1b',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_16526255-2982-4d52-b41c-6401397e7d1b" class="cnblogs_code_hide">
<pre><span style="color: #000000;">function bindChangeAvatar1() {
            $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#avatarImg</span><span style="color: #800000;">'</span><span style="color: #000000;">).change(function () {
                var file_obj </span>=<span style="color: #000000;"> $(this)[0].files[0];
                $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#prevViewImg</span><span style="color: #800000;">'</span>)[0].src =<span style="color: #000000;"> window.URL.createObjectURL(file_obj)
            })
        }

        function bindChangeAvatar2() {
            $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#avatarImg</span><span style="color: #800000;">'</span><span style="color: #000000;">).change(function () {
                var file_obj </span>=<span style="color: #000000;"> $(this)[0].files[0];
                var reader </span>=<span style="color: #000000;"> new FileReader();
                reader.readAsDataURL(file_obj);
                reader.onload </span>=<span style="color: #000000;"> function (e) {
                    $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#previewImg</span><span style="color: #800000;">'</span>)[0].src =<span style="color: #000000;"> this.result;
                };
            })
        }

        function bindChangeAvatar3() {
            $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#avatarImg</span><span style="color: #800000;">'</span><span style="color: #000000;">).change(function () {
                var file_obj </span>=<span style="color: #000000;"> $(this)[0].files[0];
                var form </span>=<span style="color: #000000;"> new FormData();
                form.add(</span><span style="color: #800000;">'</span><span style="color: #800000;">img_upload</span><span style="color: #800000;">'</span><span style="color: #000000;">, file_obj);

                $.ajax({
                    url: </span><span style="color: #800000;">''</span><span style="color: #000000;">,
                    data: form,
                    processData: false,  </span>// tell jQuery <span style="color: #0000ff;">not</span><span style="color: #000000;"> to process the data
                    contentType: false,  </span>// tell jQuery <span style="color: #0000ff;">not</span><span style="color: #000000;"> to set contentType
                    success: function (arg) {

                    }
                })
            })
        }

        function bindChangeAvatar4() {
            $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#avatarImg</span><span style="color: #800000;">'</span><span style="color: #000000;">).change(function () {
                $(this).parent().submit();

                $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#upload_iframe</span><span style="color: #800000;">'</span><span style="color: #000000;">).load(function () {
                    var iframeContents </span>=<span style="color: #000000;"> this.contentWindow.document.body.innerText;
                    iframeContents </span>=<span style="color: #000000;"> JSON.parse(iframeContents);
                    </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (iframeContents.status) {
                        $(</span><span style="color: #800000;">'</span><span style="color: #800000;">#previewImg</span><span style="color: #800000;">'</span>).attr(<span style="color: #800000;">'</span><span style="color: #800000;">src</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">/</span><span style="color: #800000;">'</span> +<span style="color: #000000;"> iframeContents.data);
                    }
                })

            })
        }</span></pre>
</div>
<span class="cnblogs_code_collapse">其他</span></div>
<p>&nbsp;</p>
<p><strong><span style="font-size: 14pt;">八、验证码</span></strong></p>
<p>验证码原理在于后台自动创建一张带有随机内容的图片，然后将内容通过img标签输出到页面。</p>
<p>安装图像处理模块：</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;gutter:true;">pip3 install pillow
</pre>
</div>
<p>示例截图：</p>
<p><img src="http://images2015.cnblogs.com/blog/425762/201607/425762-20160725165355091-1912704273.png" alt="" width="285" height="126" /></p>
<p>验证码Demo源码下载：<a href="http://files.cnblogs.com/files/wupeiqi/tornado_check_code.zip" target="_blank">猛击这里</a></p>
<p><strong><span style="font-size: 14pt;">九、异步非阻塞</span></strong></p>
<p>1、基本使用</p>
<p>装饰器 + Future 从而实现Tornado的异步非阻塞</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;gutter:true;">    class AsyncHandler(tornado.web.RequestHandler):

        @gen.coroutine
        def get(self):
            future = Future()
            future.add_done_callback(self.doing)
            yield future
            # 或
            # tornado.ioloop.IOLoop.current().add_future(future,self.doing)
            # yield future

        def doing(self,*args, **kwargs):
            self.write('async')
            self.finish()</pre>
</div>
<p>当发送GET请求时，由于方法被@gen.coroutine装饰且yield 一个 Future对象，那么Tornado会等待，等待用户向future对象中放置数据或者发送信号，如果获取到数据或信号之后，就开始执行doing方法。</p>
<p>异步非阻塞体现在当在Tornaod等待用户向future对象中放置数据时，还可以处理其他请求。</p>
<p>注意：在等待用户向future对象中放置数据或信号时，此连接是不断开的。</p>
<p>2、同步阻塞和异步非阻塞对比</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('77a7b6b3-5855-43a6-a7c6-d283ac737717')"><img id="code_img_closed_77a7b6b3-5855-43a6-a7c6-d283ac737717" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_77a7b6b3-5855-43a6-a7c6-d283ac737717" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('77a7b6b3-5855-43a6-a7c6-d283ac737717',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_77a7b6b3-5855-43a6-a7c6-d283ac737717" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">class</span><span style="color: #000000;"> SyncHandler(tornado.web.RequestHandler):

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.doing()
        self.write(</span><span style="color: #800000;">'</span><span style="color: #800000;">sync</span><span style="color: #800000;">'</span><span style="color: #000000;">)

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> doing(self):
        time.sleep(</span>10)</pre>
</div>
<span class="cnblogs_code_collapse">同步阻塞</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('3d9a76aa-0d12-475a-b690-5d1166cab1bf')"><img id="code_img_closed_3d9a76aa-0d12-475a-b690-5d1166cab1bf" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_3d9a76aa-0d12-475a-b690-5d1166cab1bf" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('3d9a76aa-0d12-475a-b690-5d1166cab1bf',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_3d9a76aa-0d12-475a-b690-5d1166cab1bf" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">class</span><span style="color: #000000;"> AsyncHandler(tornado.web.RequestHandler):
    @gen.coroutine
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        future </span>=<span style="color: #000000;"> Future()
        tornado.ioloop.IOLoop.current().add_timeout(time.time() </span>+ 5<span style="color: #000000;">, self.doing)
        </span><span style="color: #0000ff;">yield</span><span style="color: #000000;"> future


    </span><span style="color: #0000ff;">def</span> doing(self, *args, **<span style="color: #000000;">kwargs):
        self.write(</span><span style="color: #800000;">'</span><span style="color: #800000;">async</span><span style="color: #800000;">'</span><span style="color: #000000;">)
        self.finish()</span></pre>
</div>
<span class="cnblogs_code_collapse">异步非阻塞</span></div>
<p>3、httpclient类库</p>
<p>Tornado提供了httpclient类库用于发送Http请求，其配合Tornado的异步非阻塞使用。</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;gutter:true;">class AsyncHandler(tornado.web.RequestHandler):
    @gen.coroutine
    def get(self):
        from tornado import httpclient

        http = httpclient.AsyncHTTPClient()
        yield http.fetch("http://www.google.com", self.endding)


    def endding(self, response):
        print(len(response.body))
        self.write('ok')
        self.finish()</pre>
</div>
<h3>自定义Web组件</h3>
<p><strong><span style="font-size: 14pt;">一、Session</span></strong></p>
<p>1、面向对象基础</p>
<p>面向对象中通过索引的方式访问对象，需要内部实现 __getitem__ 、__delitem__、__setitem__方法</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;collapse:true;;gutter:true;">#!/usr/bin/env python
# -*- coding:utf-8 -*-
  
class Foo(object):
  
    def __getitem__(self, key):
        print  '__getitem__',key
  
    def __setitem__(self, key, value):
        print '__setitem__',key,value
  
    def __delitem__(self, key):
        print '__delitem__',key
  
  
  
obj = Foo()
result = obj['k1']
#obj['k2'] = 'wupeiqi'
#del obj['k1']
</pre>
</div>
<p>2、Tornado扩展</p>
<p>Tornado框架中，默认执行Handler的get/post等方法之前默认会执行 initialize方法，所以可以通过自定义的方式使得所有请求在处理前执行操作...</p>
<div class="cnblogs_Highlighter">
<pre class="brush:python;collapse:true;;gutter:true;">class BaseHandler(tornado.web.RequestHandler):
  
    def initialize(self):
        self.xxoo = "wupeiqi"
  
  
class MainHandler(BaseHandler):
  
    def get(self):
        print(self.xxoo)
        self.write('index')

class IndexHandler(BaseHandler):
  
    def get(self):
        print(self.xxoo)
        self.write('index')
</pre>
</div>
<p>3、session</p>
<p>session其实就是定义在服务器端用于保存用户回话的容器，其必须依赖cookie才能实现。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('f856a7e2-92b5-447c-a5eb-3732d0d5750e')"><img id="code_img_closed_f856a7e2-92b5-447c-a5eb-3732d0d5750e" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_f856a7e2-92b5-447c-a5eb-3732d0d5750e" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('f856a7e2-92b5-447c-a5eb-3732d0d5750e',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_f856a7e2-92b5-447c-a5eb-3732d0d5750e" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff;">import</span><span style="color: #000000;"> config
</span><span style="color: #0000ff;">from</span> hashlib <span style="color: #0000ff;">import</span><span style="color: #000000;"> sha1
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> os
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> time

create_session_id </span>= <span style="color: #0000ff;">lambda</span>: sha1(bytes(<span style="color: #800000;">'</span><span style="color: #800000;">%s%s</span><span style="color: #800000;">'</span> % (os.urandom(16), time.time()), encoding=<span style="color: #800000;">'</span><span style="color: #800000;">utf-8</span><span style="color: #800000;">'</span><span style="color: #000000;">)).hexdigest()


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> SessionFactory:

    @staticmethod
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get_session_obj(handler):
        obj </span>=<span style="color: #000000;"> None

        </span><span style="color: #0000ff;">if</span> config.SESSION_TYPE == <span style="color: #800000;">"</span><span style="color: #800000;">cache</span><span style="color: #800000;">"</span><span style="color: #000000;">:
            obj </span>=<span style="color: #000000;"> CacheSession(handler)
        </span><span style="color: #0000ff;">elif</span> config.SESSION_TYPE == <span style="color: #800000;">"</span><span style="color: #800000;">memcached</span><span style="color: #800000;">"</span><span style="color: #000000;">:
            obj </span>=<span style="color: #000000;"> MemcachedSession(handler)
        </span><span style="color: #0000ff;">elif</span> config.SESSION_TYPE == <span style="color: #800000;">"</span><span style="color: #800000;">redis</span><span style="color: #800000;">"</span><span style="color: #000000;">:
            obj </span>=<span style="color: #000000;"> RedisSession(handler)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> obj


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> CacheSession:
    session_container </span>=<span style="color: #000000;"> {}
    session_id </span>= <span style="color: #800000;">"</span><span style="color: #800000;">__sessionId__</span><span style="color: #800000;">"</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self, handler):
        self.handler </span>=<span style="color: #000000;"> handler
        client_random_str </span>=<span style="color: #000000;"> handler.get_cookie(CacheSession.session_id, None)
        </span><span style="color: #0000ff;">if</span> client_random_str <span style="color: #0000ff;">and</span> client_random_str <span style="color: #0000ff;">in</span><span style="color: #000000;"> CacheSession.session_container:
            self.random_str </span>=<span style="color: #000000;"> client_random_str
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self.random_str </span>=<span style="color: #000000;"> create_session_id()
            CacheSession.session_container[self.random_str] </span>=<span style="color: #000000;"> {}

        expires_time </span>= time.time() +<span style="color: #000000;"> config.SESSION_EXPIRES
        handler.set_cookie(CacheSession.session_id, self.random_str, expires</span>=<span style="color: #000000;">expires_time)

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__getitem__</span><span style="color: #000000;">(self, key):
        ret </span>=<span style="color: #000000;"> CacheSession.session_container[self.random_str].get(key, None)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> ret

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__setitem__</span><span style="color: #000000;">(self, key, value):
        CacheSession.session_container[self.random_str][key] </span>=<span style="color: #000000;"> value

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__delitem__</span><span style="color: #000000;">(self, key):
        </span><span style="color: #0000ff;">if</span> key <span style="color: #0000ff;">in</span><span style="color: #000000;"> CacheSession.session_container[self.random_str]:
            </span><span style="color: #0000ff;">del</span><span style="color: #000000;"> CacheSession.session_container[self.random_str][key]


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> RedisSession:
    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self, handler):
        </span><span style="color: #0000ff;">pass</span>


<span style="color: #0000ff;">class</span><span style="color: #000000;"> MemcachedSession:
    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self, handler):
        </span><span style="color: #0000ff;">pass</span></pre>
</div>
<span class="cnblogs_code_collapse">自定义Session</span></div>
<p>4、分布式Session</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('d6bdeedf-9223-4768-854d-4b8b89a8e0d9')"><img id="code_img_closed_d6bdeedf-9223-4768-854d-4b8b89a8e0d9" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_d6bdeedf-9223-4768-854d-4b8b89a8e0d9" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('d6bdeedf-9223-4768-854d-4b8b89a8e0d9',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_d6bdeedf-9223-4768-854d-4b8b89a8e0d9" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;">coding:utf-8</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> sys
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> math
</span><span style="color: #0000ff;">from</span> bisect <span style="color: #0000ff;">import</span><span style="color: #000000;"> bisect


</span><span style="color: #0000ff;">if</span> sys.version_info &gt;= (2, 5<span style="color: #000000;">):
    </span><span style="color: #0000ff;">import</span><span style="color: #000000;"> hashlib
    md5_constructor </span>=<span style="color: #000000;"> hashlib.md5
</span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
    </span><span style="color: #0000ff;">import</span><span style="color: #000000;"> md5
    md5_constructor </span>=<span style="color: #000000;"> md5.new


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> HashRing(object):
    </span><span style="color: #800000;">"""</span><span style="color: #800000;">一致性哈希</span><span style="color: #800000;">"""</span>
    
    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self,nodes):
        </span><span style="color: #800000;">'''</span><span style="color: #800000;">初始化
        nodes : 初始化的节点，其中包含节点已经节点对应的权重
                默认每一个节点有32个虚拟节点
                对于权重，通过多创建虚拟节点来实现
                如：nodes = [
                        {'host':'127.0.0.1:8000','weight':1},
                        {'host':'127.0.0.1:8001','weight':2},
                        {'host':'127.0.0.1:8002','weight':1},
                    ]
        </span><span style="color: #800000;">'''</span><span style="color: #000000;">
        
        self.ring </span>=<span style="color: #000000;"> dict()
        self._sorted_keys </span>=<span style="color: #000000;"> []

        self.total_weight </span>=<span style="color: #000000;"> 0
        
        self.</span><span style="color: #800080;">__generate_circle</span><span style="color: #000000;">(nodes)
        
            
            
    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__generate_circle</span><span style="color: #000000;">(self,nodes):
        </span><span style="color: #0000ff;">for</span> node_info <span style="color: #0000ff;">in</span><span style="color: #000000;"> nodes:
            self.total_weight </span>+= node_info.get(<span style="color: #800000;">'</span><span style="color: #800000;">weight</span><span style="color: #800000;">'</span>,1<span style="color: #000000;">)
            
        </span><span style="color: #0000ff;">for</span> node_info <span style="color: #0000ff;">in</span><span style="color: #000000;"> nodes:
            weight </span>= node_info.get(<span style="color: #800000;">'</span><span style="color: #800000;">weight</span><span style="color: #800000;">'</span>,1<span style="color: #000000;">)
            node </span>= node_info.get(<span style="color: #800000;">'</span><span style="color: #800000;">host</span><span style="color: #800000;">'</span><span style="color: #000000;">,None)
                
            virtual_node_count </span>= math.floor((32*len(nodes)*weight) /<span style="color: #000000;"> self.total_weight)
            </span><span style="color: #0000ff;">for</span> i <span style="color: #0000ff;">in</span><span style="color: #000000;"> xrange(0,int(virtual_node_count)):
                key </span>= self.gen_key_thirty_two( <span style="color: #800000;">'</span><span style="color: #800000;">%s-%s</span><span style="color: #800000;">'</span> %<span style="color: #000000;"> (node, i) )
                </span><span style="color: #0000ff;">if</span> self._sorted_keys.<span style="color: #800080;">__contains__</span><span style="color: #000000;">(key):
                    </span><span style="color: #0000ff;">raise</span> Exception(<span style="color: #800000;">'</span><span style="color: #800000;">该节点已经存在.</span><span style="color: #800000;">'</span><span style="color: #000000;">)
                self.ring[key] </span>=<span style="color: #000000;"> node
                self._sorted_keys.append(key)
            
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> add_node(self,node):
        </span><span style="color: #800000;">'''</span><span style="color: #800000;"> 新建节点
        node : 要添加的节点，格式为：{'host':'127.0.0.1:8002','weight':1}，其中第一个元素表示节点，第二个元素表示该节点的权重。
        </span><span style="color: #800000;">'''</span><span style="color: #000000;">
        node </span>= node.get(<span style="color: #800000;">'</span><span style="color: #800000;">host</span><span style="color: #800000;">'</span><span style="color: #000000;">,None)
        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> node:
                </span><span style="color: #0000ff;">raise</span> Exception(<span style="color: #800000;">'</span><span style="color: #800000;">节点的地址不能为空.</span><span style="color: #800000;">'</span><span style="color: #000000;">)
                
        weight </span>= node.get(<span style="color: #800000;">'</span><span style="color: #800000;">weight</span><span style="color: #800000;">'</span>,1<span style="color: #000000;">)
        
        self.total_weight </span>+=<span style="color: #000000;"> weight
        nodes_count </span>= len(self._sorted_keys) + 1<span style="color: #000000;">
        
        virtual_node_count </span>= math.floor((32 * nodes_count * weight) /<span style="color: #000000;"> self.total_weight)
        </span><span style="color: #0000ff;">for</span> i <span style="color: #0000ff;">in</span><span style="color: #000000;"> xrange(0,int(virtual_node_count)):
            key </span>= self.gen_key_thirty_two( <span style="color: #800000;">'</span><span style="color: #800000;">%s-%s</span><span style="color: #800000;">'</span> %<span style="color: #000000;"> (node, i) )
            </span><span style="color: #0000ff;">if</span> self._sorted_keys.<span style="color: #800080;">__contains__</span><span style="color: #000000;">(key):
                </span><span style="color: #0000ff;">raise</span> Exception(<span style="color: #800000;">'</span><span style="color: #800000;">该节点已经存在.</span><span style="color: #800000;">'</span><span style="color: #000000;">)
            self.ring[key] </span>=<span style="color: #000000;"> node
            self._sorted_keys.append(key)
        
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> remove_node(self,node):
        </span><span style="color: #800000;">'''</span><span style="color: #800000;"> 移除节点
        node : 要移除的节点 '127.0.0.1:8000'
        </span><span style="color: #800000;">'''</span>
        <span style="color: #0000ff;">for</span> key,value <span style="color: #0000ff;">in</span><span style="color: #000000;"> self.ring.items():
            </span><span style="color: #0000ff;">if</span> value ==<span style="color: #000000;"> node:
                </span><span style="color: #0000ff;">del</span><span style="color: #000000;"> self.ring[key]
                self._sorted_keys.remove(key)
    
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get_node(self,string_key):
        </span><span style="color: #800000;">'''</span><span style="color: #800000;">获取 string_key 所在的节点</span><span style="color: #800000;">'''</span><span style="color: #000000;">
        pos </span>=<span style="color: #000000;"> self.get_node_pos(string_key)
        </span><span style="color: #0000ff;">if</span> pos <span style="color: #0000ff;">is</span><span style="color: #000000;"> None:
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
        </span><span style="color: #0000ff;">return</span> self.ring[ self._sorted_keys[pos]].split(<span style="color: #800000;">'</span><span style="color: #800000;">:</span><span style="color: #800000;">'</span><span style="color: #000000;">)
    
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get_node_pos(self,string_key):
        </span><span style="color: #800000;">'''</span><span style="color: #800000;">获取 string_key 所在的节点的索引</span><span style="color: #800000;">'''</span>
        <span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> self.ring:
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
            
        key </span>=<span style="color: #000000;"> self.gen_key_thirty_two(string_key)
        nodes </span>=<span style="color: #000000;"> self._sorted_keys
        pos </span>=<span style="color: #000000;"> bisect(nodes, key)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> pos
    
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> gen_key_thirty_two(self, key):
        
        m </span>=<span style="color: #000000;"> md5_constructor()
        m.update(key)
        </span><span style="color: #0000ff;">return</span> long(m.hexdigest(), 16<span style="color: #000000;">)
        
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> gen_key_sixteen(self,key):
        
        b_key </span>= self.<span style="color: #800080;">__hash_digest</span><span style="color: #000000;">(key)
        </span><span style="color: #0000ff;">return</span> self.<span style="color: #800080;">__hash_val</span>(b_key, <span style="color: #0000ff;">lambda</span><span style="color: #000000;"> x: x)

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__hash_val</span><span style="color: #000000;">(self, b_key, entry_fn):
        </span><span style="color: #0000ff;">return</span> (( b_key[entry_fn(3)] &lt;&lt; 24)|(b_key[entry_fn(2)] &lt;&lt; 16)|(b_key[entry_fn(1)] &lt;&lt; 8)|<span style="color: #000000;"> b_key[entry_fn(0)] )

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__hash_digest</span><span style="color: #000000;">(self, key):
        m </span>=<span style="color: #000000;"> md5_constructor()
        m.update(key)
        </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> map(ord, m.digest())


</span><span style="color: #800000;">"""</span><span style="color: #800000;">
nodes = [
    {'host':'127.0.0.1:8000','weight':1},
    {'host':'127.0.0.1:8001','weight':2},
    {'host':'127.0.0.1:8002','weight':1},
]

ring = HashRing(nodes)
result = ring.get_node('98708798709870987098709879087')
print result

</span><span style="color: #800000;">"""</span></pre>
</div>
<span class="cnblogs_code_collapse">一致性哈西</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('57ab0666-75d4-4453-a94e-54b08dc92ad5')"><img id="code_img_closed_57ab0666-75d4-4453-a94e-54b08dc92ad5" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_57ab0666-75d4-4453-a94e-54b08dc92ad5" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('57ab0666-75d4-4453-a94e-54b08dc92ad5',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_57ab0666-75d4-4453-a94e-54b08dc92ad5" class="cnblogs_code_hide">
<pre><span style="color: #0000ff;">from</span> hashlib <span style="color: #0000ff;">import</span><span style="color: #000000;"> sha1
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> os, time


create_session_id </span>= <span style="color: #0000ff;">lambda</span>: sha1(<span style="color: #800000;">'</span><span style="color: #800000;">%s%s</span><span style="color: #800000;">'</span> % (os.urandom(16<span style="color: #000000;">), time.time())).hexdigest()


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> Session(object):

    session_id </span>= <span style="color: #800000;">"</span><span style="color: #800000;">__sessionId__</span><span style="color: #800000;">"</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self, request):
        session_value </span>=<span style="color: #000000;"> request.get_cookie(Session.session_id)
        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> session_value:
            self._id </span>=<span style="color: #000000;"> create_session_id()
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            self._id </span>=<span style="color: #000000;"> session_value
        request.set_cookie(Session.session_id, self._id)

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__getitem__</span><span style="color: #000000;">(self, key):
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> 根据 self._id ，在一致性哈西中找到其对应的服务器IP</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 找到相对应的redis服务器，如： r = redis.StrictRedis(host='localhost', port=6379, db=0)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 使用python redis api 链接</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 获取数据，即：</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> return self._redis.hget(self._id, name)</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__setitem__</span><span style="color: #000000;">(self, key, value):
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> 根据 self._id ，在一致性哈西中找到其对应的服务器IP</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 使用python redis api 链接</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 设置session</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> self._redis.hset(self._id, name, value)</span>


    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__delitem__</span><span style="color: #000000;">(self, key):
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> 根据 self._id 找到相对应的redis服务器</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 使用python redis api 链接</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> 删除，即：</span>
        <span style="color: #0000ff;">return</span> self._redis.hdel(self._id, name)</pre>
</div>
<span class="cnblogs_code_collapse">session</span></div>
<p><strong><span style="font-size: 14pt;">二、表单验证</span></strong></p>
<p>在Web程序中往往包含大量的表单验证的工作，如：判断输入是否为空，是否符合规则。</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('8a85cabb-5873-453f-82d8-961e58151082')"><img id="code_img_closed_8a85cabb-5873-453f-82d8-961e58151082" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_8a85cabb-5873-453f-82d8-961e58151082" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('8a85cabb-5873-453f-82d8-961e58151082',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_8a85cabb-5873-453f-82d8-961e58151082" class="cnblogs_code_hide">
<pre>&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head lang=<span style="color: #800000;">"</span><span style="color: #800000;">en</span><span style="color: #800000;">"</span>&gt;
    &lt;meta charset=<span style="color: #800000;">"</span><span style="color: #800000;">UTF-8</span><span style="color: #800000;">"</span>&gt;
    &lt;title&gt;&lt;/title&gt;
    &lt;link href=<span style="color: #800000;">"</span><span style="color: #800000;">{{static_url(</span><span style="color: #800000;">"</span>commons.css<span style="color: #800000;">"</span><span style="color: #800000;">)}}</span><span style="color: #800000;">"</span> rel=<span style="color: #800000;">"</span><span style="color: #800000;">stylesheet</span><span style="color: #800000;">"</span> /&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;hello&lt;/h1&gt;
    &lt;form action=<span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span> method=<span style="color: #800000;">"</span><span style="color: #800000;">post</span><span style="color: #800000;">"</span>&gt;

        &lt;p&gt;hostname: &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">text</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">host</span><span style="color: #800000;">"</span> /&gt; &lt;/p&gt;
        &lt;p&gt;ip: &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">text</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">ip</span><span style="color: #800000;">"</span> /&gt; &lt;/p&gt;
        &lt;p&gt;port: &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">text</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">port</span><span style="color: #800000;">"</span> /&gt; &lt;/p&gt;
        &lt;p&gt;phone: &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">text</span><span style="color: #800000;">"</span> name=<span style="color: #800000;">"</span><span style="color: #800000;">phone</span><span style="color: #800000;">"</span> /&gt; &lt;/p&gt;
        &lt;input type=<span style="color: #800000;">"</span><span style="color: #800000;">submit</span><span style="color: #800000;">"</span> /&gt;
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</pre>
</div>
<span class="cnblogs_code_collapse">HTML</span></div>
<div class="cnblogs_code" onclick="cnblogs_code_show('b384f6a1-e346-424a-9bf8-ec113adf98b3')"><img id="code_img_closed_b384f6a1-e346-424a-9bf8-ec113adf98b3" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_b384f6a1-e346-424a-9bf8-ec113adf98b3" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('b384f6a1-e346-424a-9bf8-ec113adf98b3',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_b384f6a1-e346-424a-9bf8-ec113adf98b3" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>
  
<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
</span><span style="color: #0000ff;">from</span> hashlib <span style="color: #0000ff;">import</span><span style="color: #000000;"> sha1
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> os, time
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> re
  
  
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainForm(object):
    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self):
        self.host </span>= <span style="color: #800000;">"</span><span style="color: #800000;">(.*)</span><span style="color: #800000;">"</span><span style="color: #000000;">
        self.ip </span>= <span style="color: #800000;">"</span><span style="color: #800000;">^(25[0-5]|2[0-4]\d|[0-1]?\d?\d)(\.(25[0-5]|2[0-4]\d|[0-1]?\d?\d)){3}$</span><span style="color: #800000;">"</span><span style="color: #000000;">
        self.port </span>= <span style="color: #800000;">'</span><span style="color: #800000;">(\d+)</span><span style="color: #800000;">'</span><span style="color: #000000;">
        self.phone </span>= <span style="color: #800000;">'</span><span style="color: #800000;">^1[3|4|5|8][0-9]\d{8}$</span><span style="color: #800000;">'</span>
  
    <span style="color: #0000ff;">def</span><span style="color: #000000;"> check_valid(self, request):
        form_dict </span>= self.<span style="color: #800080;">__dict__</span>
        <span style="color: #0000ff;">for</span> key, regular <span style="color: #0000ff;">in</span><span style="color: #000000;"> form_dict.items():
            post_value </span>=<span style="color: #000000;"> request.get_argument(key)
            </span><span style="color: #008000;">#</span><span style="color: #008000;"> 让提交的数据 和 定义的正则表达式进行匹配</span>
            ret =<span style="color: #000000;"> re.match(regular, post_value)
            </span><span style="color: #0000ff;">print</span><span style="color: #000000;"> key,ret,post_value
  
  
</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">index.html</span><span style="color: #800000;">'</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">def</span> post(self, *args, **<span style="color: #000000;">kwargs):
        obj </span>=<span style="color: #000000;"> MainForm()
        result </span>=<span style="color: #000000;"> obj.check_valid(self)
        self.write(</span><span style="color: #800000;">'</span><span style="color: #800000;">ok</span><span style="color: #800000;">'</span><span style="color: #000000;">)
  
  
  
settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">cookie_secret</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">aiuasdhflashjdfoiuashdfiuh</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">login_url</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/login</span><span style="color: #800000;">'</span><span style="color: #000000;">
}
  
application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)
  
  
</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8888<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">Python</span></div>
<p>由于验证规则可以代码重用，所以可以如此定义：</p>
<div class="cnblogs_code" onclick="cnblogs_code_show('1ed0f105-6b75-486a-9421-26cedbe3ad34')"><img id="code_img_closed_1ed0f105-6b75-486a-9421-26cedbe3ad34" class="code_img_closed" src="http://images.cnblogs.com/OutliningIndicators/ContractedBlock.gif" alt="" /><img id="code_img_opened_1ed0f105-6b75-486a-9421-26cedbe3ad34" class="code_img_opened" style="display: none;" onclick="cnblogs_code_hide('1ed0f105-6b75-486a-9421-26cedbe3ad34',event)" src="http://images.cnblogs.com/OutliningIndicators/ExpandedBlockStart.gif" alt="" />
<div id="cnblogs_code_open_1ed0f105-6b75-486a-9421-26cedbe3ad34" class="cnblogs_code_hide">
<pre><span style="color: #008000;">#</span><span style="color: #008000;">!/usr/bin/env python</span><span style="color: #008000;">
#</span><span style="color: #008000;"> -*- coding:utf-8 -*-</span>

<span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.ioloop
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> tornado.web
</span><span style="color: #0000ff;">import</span><span style="color: #000000;"> re


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> Field(object):

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self, error_msg_dict, required):
        self.id_valid </span>=<span style="color: #000000;"> False
        self.value </span>=<span style="color: #000000;"> None
        self.error </span>=<span style="color: #000000;"> None
        self.name </span>=<span style="color: #000000;"> None
        self.error_msg </span>=<span style="color: #000000;"> error_msg_dict
        self.required </span>=<span style="color: #000000;"> required

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> match(self, name, value):
        self.name </span>=<span style="color: #000000;"> name

        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> self.required:
            self.id_valid </span>=<span style="color: #000000;"> True
            self.value </span>=<span style="color: #000000;"> value
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> value:
                </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                    self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is required</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name
            </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                ret </span>=<span style="color: #000000;"> re.match(self.REGULAR, value)
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> ret:
                    self.id_valid </span>=<span style="color: #000000;"> True
                    self.value </span>=<span style="color: #000000;"> ret.group()
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                        self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                    </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                        self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is invalid</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> IPField(Field):
    REGULAR </span>= <span style="color: #800000;">"</span><span style="color: #800000;">^(25[0-5]|2[0-4]\d|[0-1]?\d?\d)(\.(25[0-5]|2[0-4]\d|[0-1]?\d?\d)){3}$</span><span style="color: #800000;">"</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span>(self, error_msg_dict=None, required=<span style="color: #000000;">True):

        error_msg </span>= {}  <span style="color: #008000;">#</span><span style="color: #008000;"> {'required': 'IP不能为空', 'valid': 'IP格式错误'}</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> error_msg_dict:
            error_msg.update(error_msg_dict)

        super(IPField, self).</span><span style="color: #800080;">__init__</span>(error_msg_dict=error_msg, required=<span style="color: #000000;">required)


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> IntegerField(Field):
    REGULAR </span>= <span style="color: #800000;">"</span><span style="color: #800000;">^\d+$</span><span style="color: #800000;">"</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span>(self, error_msg_dict=None, required=<span style="color: #000000;">True):
        error_msg </span>= {<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">数字不能为空</span><span style="color: #800000;">'</span>, <span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">数字格式错误</span><span style="color: #800000;">'</span><span style="color: #000000;">}
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> error_msg_dict:
            error_msg.update(error_msg_dict)

        super(IntegerField, self).</span><span style="color: #800080;">__init__</span>(error_msg_dict=error_msg, required=<span style="color: #000000;">required)


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> CheckBoxField(Field):

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span>(self, error_msg_dict=None, required=<span style="color: #000000;">True):
        error_msg </span>= {}  <span style="color: #008000;">#</span><span style="color: #008000;"> {'required': 'IP不能为空', 'valid': 'IP格式错误'}</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> error_msg_dict:
            error_msg.update(error_msg_dict)

        super(CheckBoxField, self).</span><span style="color: #800080;">__init__</span>(error_msg_dict=error_msg, required=<span style="color: #000000;">required)

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> match(self, name, value):
        self.name </span>=<span style="color: #000000;"> name

        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> self.required:
            self.id_valid </span>=<span style="color: #000000;"> True
            self.value </span>=<span style="color: #000000;"> value
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> value:
                </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                    self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is required</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name
            </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(name, list):
                    self.id_valid </span>=<span style="color: #000000;"> True
                    self.value </span>=<span style="color: #000000;"> value
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                        self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                    </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                        self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is invalid</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> FileField(Field):
    REGULAR </span>= <span style="color: #800000;">"</span><span style="color: #800000;">^(\w+\.pdf)|(\w+\.mp3)|(\w+\.py)$</span><span style="color: #800000;">"</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span>(self, error_msg_dict=None, required=<span style="color: #000000;">True):
        error_msg </span>= {}  <span style="color: #008000;">#</span><span style="color: #008000;"> {'required': '数字不能为空', 'valid': '数字格式错误'}</span>
        <span style="color: #0000ff;">if</span><span style="color: #000000;"> error_msg_dict:
            error_msg.update(error_msg_dict)

        super(FileField, self).</span><span style="color: #800080;">__init__</span>(error_msg_dict=error_msg, required=<span style="color: #000000;">required)

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> match(self, name, value):
        self.name </span>=<span style="color: #000000;"> name
        self.value </span>=<span style="color: #000000;"> []
        </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> self.required:
            self.id_valid </span>=<span style="color: #000000;"> True
            self.value </span>=<span style="color: #000000;"> value
        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
            </span><span style="color: #0000ff;">if</span> <span style="color: #0000ff;">not</span><span style="color: #000000;"> value:
                </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                    self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">required</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is required</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name
            </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                m </span>=<span style="color: #000000;"> re.compile(self.REGULAR)
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(value, list):
                    </span><span style="color: #0000ff;">for</span> file_name <span style="color: #0000ff;">in</span><span style="color: #000000;"> value:
                        r </span>=<span style="color: #000000;"> m.match(file_name)
                        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> r:
                            self.value.append(r.group())
                            self.id_valid </span>=<span style="color: #000000;"> True
                        </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                            self.id_valid </span>=<span style="color: #000000;"> False
                            </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                                self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                            </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                                self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is invalid</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name
                            </span><span style="color: #0000ff;">break</span>
                <span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    </span><span style="color: #0000ff;">if</span> self.error_msg.get(<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">, None):
                        self.error </span>= self.error_msg[<span style="color: #800000;">'</span><span style="color: #800000;">valid</span><span style="color: #800000;">'</span><span style="color: #000000;">]
                    </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                        self.error </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s is invalid</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> name

    </span><span style="color: #0000ff;">def</span> save(self, request, upload_path=<span style="color: #800000;">""</span><span style="color: #000000;">):

        file_metas </span>=<span style="color: #000000;"> request.files[self.name]
        </span><span style="color: #0000ff;">for</span> meta <span style="color: #0000ff;">in</span><span style="color: #000000;"> file_metas:
            file_name </span>= meta[<span style="color: #800000;">'</span><span style="color: #800000;">filename</span><span style="color: #800000;">'</span><span style="color: #000000;">]
            with open(file_name,</span><span style="color: #800000;">'</span><span style="color: #800000;">wb</span><span style="color: #800000;">'</span><span style="color: #000000;">) as up:
                up.write(meta[</span><span style="color: #800000;">'</span><span style="color: #800000;">body</span><span style="color: #800000;">'</span><span style="color: #000000;">])


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> Form(object):

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self):
        self.value_dict </span>=<span style="color: #000000;"> {}
        self.error_dict </span>=<span style="color: #000000;"> {}
        self.valid_status </span>=<span style="color: #000000;"> True

    </span><span style="color: #0000ff;">def</span> validate(self, request, depth=10, pre_key=<span style="color: #800000;">""</span><span style="color: #000000;">):

        self.initialize()
        self.</span><span style="color: #800080;">__valid</span><span style="color: #000000;">(self, request, depth, pre_key)

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> initialize(self):
        </span><span style="color: #0000ff;">pass</span>

    <span style="color: #0000ff;">def</span> <span style="color: #800080;">__valid</span><span style="color: #000000;">(self, form_obj, request, depth, pre_key):
        </span><span style="color: #800000;">"""</span><span style="color: #800000;">
        验证用户表单请求的数据
        :param form_obj: Form对象（Form派生类的对象）
        :param request: Http请求上下文（用于从请求中获取用户提交的值）
        :param depth: 对Form内容的深度的支持
        :param pre_key: Html中name属性值的前缀（多层Form时，内部递归时设置，无需理会）
        :return: 是否验证通过，True：验证成功；False：验证失败
        </span><span style="color: #800000;">"""</span><span style="color: #000000;">

        depth </span>-= 1
        <span style="color: #0000ff;">if</span> depth &lt;<span style="color: #000000;"> 0:
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> None
        form_field_dict </span>= form_obj.<span style="color: #800080;">__dict__</span>
        <span style="color: #0000ff;">for</span> key, field_obj <span style="color: #0000ff;">in</span><span style="color: #000000;"> form_field_dict.items():
            </span><span style="color: #0000ff;">print</span><span style="color: #000000;"> key,field_obj
            </span><span style="color: #0000ff;">if</span> isinstance(field_obj, Form) <span style="color: #0000ff;">or</span><span style="color: #000000;"> isinstance(field_obj, Field):
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(field_obj, Form):
                    </span><span style="color: #008000;">#</span><span style="color: #008000;"> 获取以key开头的所有的值，以参数的形式传至</span>
                    self.<span style="color: #800080;">__valid</span><span style="color: #000000;">(field_obj, request, depth, key)
                    </span><span style="color: #0000ff;">continue</span>
                <span style="color: #0000ff;">if</span><span style="color: #000000;"> pre_key:
                    key </span>= <span style="color: #800000;">"</span><span style="color: #800000;">%s.%s</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> (pre_key, key)

                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> isinstance(field_obj, CheckBoxField):
                    post_value </span>=<span style="color: #000000;"> request.get_arguments(key, None)
                </span><span style="color: #0000ff;">elif</span><span style="color: #000000;"> isinstance(field_obj, FileField):
                    post_value </span>=<span style="color: #000000;"> []
                    file_list </span>=<span style="color: #000000;"> request.request.files.get(key, None)
                    </span><span style="color: #0000ff;">for</span> file_item <span style="color: #0000ff;">in</span><span style="color: #000000;"> file_list:
                        post_value.append(file_item[</span><span style="color: #800000;">'</span><span style="color: #800000;">filename</span><span style="color: #800000;">'</span><span style="color: #000000;">])
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    post_value </span>=<span style="color: #000000;"> request.get_argument(key, None)

                </span><span style="color: #0000ff;">print</span><span style="color: #000000;"> post_value
                </span><span style="color: #008000;">#</span><span style="color: #008000;"> 让提交的数据 和 定义的正则表达式进行匹配</span>
<span style="color: #000000;">                field_obj.match(key, post_value)
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> field_obj.id_valid:
                    self.value_dict[key] </span>=<span style="color: #000000;"> field_obj.value
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    self.error_dict[key] </span>=<span style="color: #000000;"> field_obj.error
                    self.valid_status </span>=<span style="color: #000000;"> False


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> ListForm(object):
    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self, form_type):
        self.form_type </span>=<span style="color: #000000;"> form_type
        self.valid_status </span>=<span style="color: #000000;"> True
        self.value_dict </span>=<span style="color: #000000;"> {}
        self.error_dict </span>=<span style="color: #000000;"> {}

    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> validate(self, request):
        name_list </span>= request.request.arguments.keys() +<span style="color: #000000;"> request.request.files.keys()
        index </span>=<span style="color: #000000;"> 0
        flag </span>=<span style="color: #000000;"> False
        </span><span style="color: #0000ff;">while</span><span style="color: #000000;"> True:
            pre_key </span>= <span style="color: #800000;">"</span><span style="color: #800000;">[%d]</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> index
            </span><span style="color: #0000ff;">for</span> name <span style="color: #0000ff;">in</span><span style="color: #000000;"> name_list:
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> name.startswith(pre_key):
                    flag </span>=<span style="color: #000000;"> True
                    </span><span style="color: #0000ff;">break</span>
            <span style="color: #0000ff;">if</span><span style="color: #000000;"> flag:
                form_obj </span>=<span style="color: #000000;"> self.form_type()
                form_obj.validate(request, depth</span>=10, pre_key=<span style="color: #800000;">"</span><span style="color: #800000;">[%d]</span><span style="color: #800000;">"</span> %<span style="color: #000000;"> index)
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> form_obj.valid_status:
                    self.value_dict[index] </span>=<span style="color: #000000;"> form_obj.value_dict
                </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                    self.error_dict[index] </span>=<span style="color: #000000;"> form_obj.error_dict
                    self.valid_status </span>=<span style="color: #000000;"> False
            </span><span style="color: #0000ff;">else</span><span style="color: #000000;">:
                </span><span style="color: #0000ff;">break</span><span style="color: #000000;">

            index </span>+= 1<span style="color: #000000;">
            flag </span>=<span style="color: #000000;"> False


</span><span style="color: #0000ff;">class</span><span style="color: #000000;"> MainForm(Form):

    </span><span style="color: #0000ff;">def</span> <span style="color: #800080;">__init__</span><span style="color: #000000;">(self):
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> self.ip = IPField(required=True)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> self.port = IntegerField(required=True)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> self.new_ip = IPField(required=True)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> self.second = SecondForm()</span>
        self.fff = FileField(required=<span style="color: #000000;">True)
        super(MainForm, self).</span><span style="color: #800080;">__init__</span><span style="color: #000000;">()

</span><span style="color: #008000;">#
#</span><span style="color: #008000;"> class SecondForm(Form):</span><span style="color: #008000;">
#
#</span><span style="color: #008000;">     def __init__(self):</span><span style="color: #008000;">
#</span><span style="color: #008000;">         self.ip = IPField(required=True)</span><span style="color: #008000;">
#</span><span style="color: #008000;">         self.new_ip = IPField(required=True)</span><span style="color: #008000;">
#
#</span><span style="color: #008000;">         super(SecondForm, self).__init__()</span>


<span style="color: #0000ff;">class</span><span style="color: #000000;"> MainHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff;">def</span><span style="color: #000000;"> get(self):
        self.render(</span><span style="color: #800000;">'</span><span style="color: #800000;">index.html</span><span style="color: #800000;">'</span><span style="color: #000000;">)
    </span><span style="color: #0000ff;">def</span> post(self, *args, **<span style="color: #000000;">kwargs):
        </span><span style="color: #008000;">#</span><span style="color: #008000;"> for i in  dir(self.request):</span>
        <span style="color: #008000;">#</span><span style="color: #008000;">     print i</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.request.arguments</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.request.files</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.request.query</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> name_list = self.request.arguments.keys() + self.request.files.keys()</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print name_list</span>

        <span style="color: #008000;">#</span><span style="color: #008000;"> list_form = ListForm(MainForm)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> list_form.validate(self)</span>
        <span style="color: #008000;">#
</span>        <span style="color: #008000;">#</span><span style="color: #008000;"> print list_form.valid_status</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print list_form.value_dict</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print list_form.error_dict</span>

        <span style="color: #008000;">#</span><span style="color: #008000;"> obj = MainForm()</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj.validate(self)</span>
        <span style="color: #008000;">#
</span>        <span style="color: #008000;">#</span><span style="color: #008000;"> print "验证结果：", obj.valid_status</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print "符合验证结果：", obj.value_dict</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print "错误信息:"</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> for key, item in obj.error_dict.items():</span>
        <span style="color: #008000;">#</span><span style="color: #008000;">     print key,item</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.get_arguments('favor'),type(self.get_arguments('favor'))</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.get_argument('favor'),type(self.get_argument('favor'))</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print type(self.get_argument('fff')),self.get_argument('fff')</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.request.files</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj = MainForm()</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj.validate(self)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print obj.valid_status</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print obj.value_dict</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print obj.error_dict</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.request,type(self.request)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj.fff.save(self.request)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> from tornado.httputil import HTTPServerRequest</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> name_list = self.request.arguments.keys() + self.request.files.keys()</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print name_list</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print self.request.files,type(self.request.files)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print len(self.request.files.get('fff'))</span>
        
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj = MainForm()</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj.validate(self)</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print obj.valid_status</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print obj.value_dict</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> print obj.error_dict</span>
        <span style="color: #008000;">#</span><span style="color: #008000;"> obj.fff.save(self.request)</span>
        self.write(<span style="color: #800000;">'</span><span style="color: #800000;">ok</span><span style="color: #800000;">'</span><span style="color: #000000;">)



settings </span>=<span style="color: #000000;"> {
    </span><span style="color: #800000;">'</span><span style="color: #800000;">template_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">template</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_path</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">static</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">static_url_prefix</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/static/</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">cookie_secret</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">aiuasdhflashjdfoiuashdfiuh</span><span style="color: #800000;">'</span><span style="color: #000000;">,
    </span><span style="color: #800000;">'</span><span style="color: #800000;">login_url</span><span style="color: #800000;">'</span>: <span style="color: #800000;">'</span><span style="color: #800000;">/login</span><span style="color: #800000;">'</span><span style="color: #000000;">
}

application </span>=<span style="color: #000000;"> tornado.web.Application([
    (r</span><span style="color: #800000;">"</span><span style="color: #800000;">/index</span><span style="color: #800000;">"</span><span style="color: #000000;">, MainHandler),
], </span>**<span style="color: #000000;">settings)


</span><span style="color: #0000ff;">if</span> <span style="color: #800080;">__name__</span> == <span style="color: #800000;">"</span><span style="color: #800000;">__main__</span><span style="color: #800000;">"</span><span style="color: #000000;">:
    application.listen(</span>8888<span style="color: #000000;">)
    tornado.ioloop.IOLoop.instance().start()</span></pre>
</div>
<span class="cnblogs_code_collapse">View Code</span></div>
<p>&nbsp;</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class = "postDesc">posted @ <span id="post-date">2016-07-25 11:33</span> <a href='http://www.cnblogs.com/wupeiqi/'>武沛齐</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>) &nbsp;<a href="https://i.cnblogs.com/EditArticles.aspx?postid=5702910" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(5702910);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,cb_blogId=133379,cb_entryId=5702910,cb_blogApp=currentBlogApp,cb_blogUserGuid='7208b24d-95c9-e111-aa3f-842b2b196315',cb_entryCreatedDate='2016/7/25 11:33:00';loadViewCount(cb_entryId);</script>
	
</div><!--end: topics 文章、评论容器-->
</div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id='comment_form' class='commentform'>
<a name='commentform'></a>
<div id='divCommentShow'></div>
<div id='comment_nav'><span id='span_refresh_tips'></span><a href='javascript:void(0);' onclick='return RefreshCommentList();' id='lnk_RefreshComments' runat='server' clientidmode='Static'>刷新评论</a><a href='#' onclick='return RefreshPage();'>刷新页面</a><a href='#top'>返回顶部</a></div>
<div id='comment_form_container'></div>
<div class='ad_text_commentbox' id='ad_text_under_commentbox'></div>
<div id='ad_t2'></div>
<div id='opt_under_post'></div>
<div id='cnblogs_c1' class='c_ad_block'></div>
<div id='under_post_news'></div>
<div id='cnblogs_c2' class='c_ad_block'></div>
<div id='under_post_kb'></div>
<div id='HistoryToday' class='c_ad_block'></div>
<script type='text/javascript'>
    fixPostBody();
    setTimeout(function () { incrementViewCount(cb_entryId); }, 50);
    deliverAdT2();
    deliverAdC1();
    deliverAdC2();    
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);   
</script>
</div>


	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="calendar"><div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &copy;2017 武沛齐
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
</body>
</html>
